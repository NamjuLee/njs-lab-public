"use strict";(self.webpackChunkNJS_Lab=self.webpackChunkNJS_Lab||[]).push([[15707],{15707:(e,t,n)=>{n.r(t),n.d(t,{AppUpscaler:()=>B});var o=n(31916),i=n(65812);const r=e=>{const t=e.layers.Layer,n=e=>(e=>Array.isArray(e))(e)?e[0]:e;class i extends t{constructor(){super({}),(0,o.Z)(this,"beta",void 0),this.beta=.2}call(t){return e.mul(n(t),this.beta)}}(0,o.Z)(i,"className","MultiplyBeta");class r extends t{constructor(){super({}),(0,o.Z)(this,"scale",void 0),this.scale=4}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(n(t),this.scale,"NHWC")}}(0,o.Z)(r,"className","PixelShuffle");return{scale:4,channels:3,path:"models/model.json",packageInformation:{name:"@upscalerjs/esrgan-slim",version:"1.0.0-canary.0"},meta:{dataset:"div2k"},preprocess:t=>e.mul(t,1/255),postprocess:t=>e.tidy((()=>{const n=t.clipByValue(0,1);return t.dispose(),e.mul(n,255)})),customLayers:[i,r]}};function s(e){return function(t){try{return t.shape.length===e}catch(n){}return!1}}const a=s(4),c=s(3),l=e=>e instanceof i.Tensor,d=e=>{console.warn(Array.isArray(e)?e.join("\n"):e)};function u(e){return void 0!==e&&"function"===typeof e}const p=(e,t,n)=>!(!u(e)||e.length<=1)&&(void 0===n&&"tensor"===t||"tensor"===n),h=e=>!!e&&e.aborted;const f=[(e,t,n)=>"https://cdn.jsdelivr.net/npm/".concat(e,"@").concat(t,"/").concat(n),(e,t,n)=>"https://unpkg.com/".concat(e,"@").concat(t,"/").concat(n)],m=async e=>{if((e=>void 0!==e&&!(!e.path||!e.scale))(e)){(e=>{e.customLayers&&e.customLayers.forEach((e=>{i.serialization.registerClass(e)}))})(e);return{model:await(async(e,t)=>{if(t){for(let o=0;o<f.length;o++){const r=f[o];try{const n=r(t.name,t.version,e);return await i.loadLayersModel(n)}catch(n){}}throw new Error("Could not resolve URL ".concat(e))}return await i.loadLayersModel(e)})(e.path,e.packageInformation),modelDefinition:e}}throw function(e){return e?e.path?e.scale?new Error("Bug with code"):new Error("No model scale provided"):new Error("No model path provided"):new Error("You must provide a model definition")}(e)},y=e=>"patchSize"in e,w=async(e,t)=>{await i.nextFrame();const{model:n}=await e;for(const o of t)if(y(o)){const{patchSize:e,padding:t=0}=o,r=e+2*t,s=i.tidy((()=>n.predict(i.zeros([1,r,r,3]))));await i.nextFrame(),s.dataSync(),s.dispose()}else{if("number"!==typeof o[0]||"number"!==typeof o[1])throw new Error("Invalid value passed to warmup in warmupSizes. Expected two numbers, got ".concat(o.join(",")));const[e,t]=o,r=i.tidy((()=>n.predict(i.zeros([1,t,e,3]))));await i.nextFrame(),r.dataSync(),r.dispose()}},v=e=>new Promise(((t,n)=>{const o=new Image;o.src=e,o.crossOrigin="anonymous",o.onload=()=>t(o),o.onerror=()=>n(new Error(["Failed to load image"].join(" ")))})),g=async e=>{const t=await(async e=>{if(l(e))return e;if("string"===typeof e){const t=await v(e);return i.browser.fromPixels(t)}return i.browser.fromPixels(e)})(e);if(c(t)){const e=t.expandDims(0);return t.dispose(),e}if(a(t))return t;throw(e=>new Error(["Unsupported dimensions for incoming pixels: ".concat(e.shape.length,"."),"Only 3 or 4 rank tensors are supported."].join(" ")))(t)};var b=n(24103),x=n.n(b);class S extends Error{constructor(){super(...arguments),(0,o.Z)(this,"message","The upscale request received an abort signal")}}const z=['"padding" is undefined, but "patchSize" is explicitly defined.',"Without padding, patches of images often have visible artifacting at the seams. Defining an explicit padding will resolve the artifacting.","For more information, see ".concat("https://thekevinscott.github.io/UpscalerJS/#/?id=padding-is-undefined","."),'To hide this warning, pass an explicit padding of "0".'].join("\n"),E=['The "progress" callback was provided but "patchSize" was not defined.','Without a "patchSize", the "progress" callback will never be called.',"For more information, see ".concat("https://thekevinscott.github.io/UpscalerJS/#/?id=progress-specified-without-patch-size",".")].join("\n"),C=(e,t)=>{const[n,o]=(e=>{if(4===e.shape.length)return e.shape.slice(1,3);if(3===e.shape.length)return e.shape.slice(0,2);throw new Error("Invalid shape provided to getWidthAndHeight, expected tensor of rank 3 or 4: ".concat(JSON.stringify(e.shape)))})(e);return{rows:Math.ceil(n/t),columns:Math.ceil(o/t)}},A=(e,t,n)=>{if(t[e]<0){const o=0-t[e];t[e]+=o,n[e]-=o}},_=(e,t,n,o,i,r)=>{if(n[t]>e){const s=n[t]-e;let a=0;o[t]-s<0&&(a=0-(o[t]-s)),o[t]-=s-a,n[t]-=s;const c=s-a;i[t]+=c,r[t]+=c}},k=(e,t,n)=>{n[e]>t[e]&&(n[e]=t[e])},T=e=>{let{row:t,col:n,patchSize:o,height:i,width:r,padding:s=0}=e;if(void 0===t)throw new Error("row is undefined");if(void 0===n)throw new Error("col is undefined");if(void 0===o)throw new Error("patchSize is undefined");if(void 0===i)throw new Error("height is undefined");if(void 0===r)throw new Error("width is undefined");let a=o,c=o;a>i&&(a=i),c>r&&(c=r);const l=[t*o-s,n*o-s],d=[s,s];A(0,l,d),A(1,l,d);const u=[l[0]+a+2*s,l[1]+c+2*s],p=[d[0]+a,d[1]+c];_(i,0,u,l,d,p),_(r,1,u,l,d,p);const h=[u[0]-l[0],u[1]-l[1]];k(0,h,p),k(1,h,p);return{origin:l,sliceOrigin:d,size:h,sliceSize:[p[0]-d[0],p[1]-d[1]]}};function j(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const n=i.concat(e,t);return e.forEach((e=>e.dispose())),n}function D(e,t){return t?t(e):e.clone()}const I=e=>l(e)?e.clone():e;function L(e,t,n){try{let{model:o,modelDefinition:r}=n;return async function*(){const n=I(e),s=await g(n);yield s;const a=D(s,r.preprocess);s.dispose(),yield a;const c=function(e,t,n){try{let{output:o,progress:r,patchSize:s,padding:a,progressOutput:c}=t,{model:l,modelDefinition:h}=n;return async function*(){const t=h.scale;s&&void 0===a&&d(z);const n=s;if(n){const s=3,[d,h]=e.shape.slice(1),{rows:f,columns:m}=C(e,n);yield;const{size:y}=T({row:0,col:0,patchSize:n,height:d,width:h,padding:a});let w=i.zeros([1,0,y[1]*t*m,s]);yield w;const v=f*m;for(let b=0;b<f;b++){let f=i.zeros([1,y[0]*t,0,s]);yield[f,w];for(let i=0;i<m;i++){const{origin:s,size:y,sliceOrigin:g,sliceSize:S}=T({row:b,col:i,patchSize:n,padding:a,height:d,width:h});yield[w,f];const z=e.slice([0,s[0],s[1]],[-1,y[0],y[1]]);yield[w,f,z];const E=l.predict(z);z.dispose(),yield[w,f,E];const C=E.slice([0,g[0]*t,g[1]*t],[-1,S[0]*t,S[1]*t]);if(E.dispose(),yield[w,f,C],void 0!==r&&u(r)){const e=(b*m+i+1)/v;if(r.length<=1)r(e);else{const t=C.squeeze();if(p(r,o,c))r(e,t);else{const n=await x()(t);t.dispose(),r(e,n)}}}yield[w,f,C],f=j([f,C],2),C.dispose(),yield[w,f]}w=j([w,f],1),f.dispose(),yield[w]}const g=w.squeeze();return w.dispose(),g}return r&&d(E),i.tidy((()=>l.predict(e).squeeze()))}()}catch(o){return Promise.reject(o)}}(a,t,{model:o,modelDefinition:r});let h=await c.next();for(yield h.value;!h.done;)h=await c.next(),Array.isArray(h.value)?yield[...h.value,a]:l(h.value)?yield[h.value,a]:yield a;a.dispose();const f=h.value,m=D(f,r.postprocess);if(f.dispose(),yield m,"tensor"===t.output)return m;const y=await x()(m);return m.dispose(),y}()}catch(o){return Promise.reject(o)}}const Z=r;const P=class{constructor(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,o.Z)(this,"_opts",void 0),(0,o.Z)(this,"_model",void 0),(0,o.Z)(this,"abortController",new AbortController),(0,o.Z)(this,"dispose",(async()=>{const{model:e}=await this._model;e.dispose()})),(0,o.Z)(this,"getModel",(()=>this._model)),(0,o.Z)(this,"warmup",(async e=>{await w(this._model,e)})),(0,o.Z)(this,"upscale",(async function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{model:o,modelDefinition:r}=await e._model;return async function(e,t,n){let{signal:o,...r}=t;const s=async e=>{if(await i.nextFrame(),h(o)||h(n.signal))throw Array.isArray(e)?e.forEach((e=>e.dispose())):l(e)&&e.dispose(),new S};await s();const a=await async function(e,t){let n;for(n=await e.next();!n.done;n=await e.next())t&&await t(n.value);return n.value}(L(e,r,n),s);return await s(),a}(t,n,{model:o,modelDefinition:r,signal:e.abortController.signal})})),(0,o.Z)(this,"abort",(()=>{this.abortController.abort(),this.abortController=new AbortController})),this._opts={...t},this._model=m(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Z;return function(e){return"function"===typeof e}(e)?e(i):e}(this._opts.model)),w(this._model,this._opts.warmupSizes||[])}};class B{static Init(e){new B(e)}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main";this.canvasSD=void 0,this.implementation=void 0,this.host=void 0,this.divText=void 0;const t="https://raw.githubusercontent.com/NamjuLee/data/master/img/map/worldMapGlobeA_small.png",n=new Image;n.src=t;const o=document.getElementById(e);o&&o.appendChild(n);new P({}).upscale(t).then((e=>{console.log(e);const t=document.createElement("img");t.src=e,o&&o.appendChild(t)})),console.log("upscaler done")}InitHTML(){const e=document.createElement("button");e.style.width="100px",e.style.height="20px",e.style.marginLeft="20px",e.style.zIndex="5",e.name="Clear",e.innerText="Clear",e.value="Clear",e.onclick=()=>{console.log(this),this.canvasSD.Clear()},this.host.appendChild(e),this.divText=document.createElement("div"),this.divText.id="classText",this.divText.style.zIndex="5",this.divText.innerText="class: ",this.divText.style.marginLeft="20px",this.host.appendChild(this.divText)}Init(e){console.log("this is init...")}Clear(){this.canvasSD.Clear()}}},24103:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(t){r(t)}}function a(e){try{c(o.throw(e))}catch(t){r(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,o,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,o=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){s.label=r[1];break}if(6===r[0]&&s.label<i[1]){s.label=i[1],i=r;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(r);break}i[2]&&s.ops.pop(),s.trys.pop();continue}r=t.call(e,s)}catch(a){r=[6,a],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.tensorAsBase64=t.tensorAsBuffer=void 0,t.tensorAsBuffer=function(e){return n(void 0,void 0,void 0,(function(){var t,n,i,r,s,a,c,l,d;return o(this,(function(o){switch(o.label){case 0:return t=e.shape,n=t[0],i=t[1],r=new Uint8ClampedArray(i*n*4),[4,e.data()];case 1:for(s=o.sent(),a=0,c=0;c<n;c++)for(l=0;l<i;l++)r[d=4*(c*i+l)]=s[a],r[d+1]=s[a+1],r[d+2]=s[a+2],r[d+3]=255,a+=3;return[2,r]}}))}))},t.tensorAsBase64=function(e){return n(void 0,void 0,void 0,(function(){var n,i,r,s,a,c;return o(this,(function(o){switch(o.label){case 0:return n=e.shape,i=n[0],r=n[1],[4,t.tensorAsBuffer(e)];case 1:return s=o.sent(),(a=new ImageData(r,i)).data.set(s),(c=document.createElement("canvas")).width=r,c.height=i,c.getContext("2d").putImageData(a,0,0),[2,c.toDataURL()]}}))}))},t.default=t.tensorAsBase64},31916:(e,t,n)=>{function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(e){var t=function(e,t){if("object"!==o(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===o(t)?t:String(t)}function r(e,t,n){return(t=i(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{Z:()=>r})}}]);
//# sourceMappingURL=15707.67600cea.chunk.js.map