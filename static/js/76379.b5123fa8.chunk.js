"use strict";(self.webpackChunkNJS_Lab=self.webpackChunkNJS_Lab||[]).push([[76379],{51215:(t,e,s)=>{s.d(e,{Z:()=>$t});var n=s(64092),i=s(6955),r=s(72850);const o=r.C9;function a(t,e){return{attribute:t,format:e.size>1?"".concat(e.type,"x").concat(e.size):e.type,byteOffset:e.offset||0}}function c(t){return t.stride||t.size*t.bytesPerElement}var u=s(93170),l=s(77620),h=s(95674);function d(t,e){e.offset&&h.Z.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const s=c(t),n=(void 0!==e.vertexOffset?e.vertexOffset:t.vertexOffset||0)*s+(e.elementOffset||0)*t.bytesPerElement+(t.offset||0);return{...e,offset:n,stride:s}}class f{constructor(t,e,s){this._buffer=null,this.device=t,this.id=e.id||"",this.size=e.size||1;const n=e.logicalType||e.type,i="float64"===n;let o,{defaultValue:a}=e;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0),o=i?"float32":!n&&e.isIndexed?"uint32":n||"float32";let c=function(t){switch(t){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return(0,r.Xs)(t)}}(n||o);this.doublePrecision=i,i&&!1===e.fp64&&(c=Float32Array),this.value=null,this.settings={...e,defaultType:c,defaultValue:a,logicalType:n,type:o,normalized:o.includes("norm"),size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...s,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*c(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),u.Z.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.id,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const s={};if(this.state.constant){const n=this.value;if(e){const i=d(this.getAccessor(),e),r=i.offset/n.BYTES_PER_ELEMENT,o=i.size||this.size;s[t]=n.subarray(r,r+o)}else s[t]=n}else s[t]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?s["".concat(t,"64Low")]=s[t]:s["".concat(t,"64Low")]=new Float32Array(this.size)),s}_getBufferLayout(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.id,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const s=this.getAccessor(),n=[],i={name:this.id,byteStride:c(s),attributes:n};if(this.doublePrecision){const i=function(t,e){const s=d(t,e);return{high:s,low:{...s,offset:s.offset+4*t.size}}}(s,e||{});n.push(a(t,{...s,...i.high}),a("".concat(t,"64Low"),{...s,...i.low}))}else if(e){const i=d(s,e);n.push(a(t,{...s,...i}))}else n.push(a(t,s));return i}setAccessor(t){this.state.bufferAccessor=t}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){const e=Array.from(this.value);t=[e,e]}else{const{value:e,numInstances:s,size:n}=this,i=s*n;if(e&&i&&e.length>=i){const s=new Array(n).fill(1/0),r=new Array(n).fill(-1/0);for(let t=0;t<i;)for(let i=0;i<n;i++){const n=e[t++];n<s[i]&&(s[i]=n),n>r[i]&&(r[i]=n)}t=[s,r]}}return this.state.bounds=t,t}setData(t){const{state:e}=this;let s;s=ArrayBuffer.isView(t)?{value:t}:t instanceof n.l?{buffer:t}:t;const i={...this.settings,...s};if(ArrayBuffer.isView(s.value)){if(!s.type){if(this.doublePrecision&&s.value instanceof Float64Array)i.type="float32";else{const t=o(s.value);i.type=i.normalized?t.replace("int","norm"):t}}i.bytesPerElement=s.value.BYTES_PER_ELEMENT,i.stride=c(i)}if(e.bounds=null,s.constant){let t=s.value;t=this._normalizeValue(t,[],0),this.settings.normalized&&(t=this.normalizeConstant(t));if(!(!e.constant||!this._areValuesEqual(t,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=ArrayBuffer.isView(t)?t:new Float32Array(t)}else if(s.buffer){const t=s.buffer;e.externalBuffer=t,e.constant=!1,this.value=s.value||null}else if(s.value){this._checkExternalBuffer(s);let t=s.value;e.externalBuffer=null,e.constant=!1,this.value=t;let{buffer:n}=this;const r=c(i),o=(i.vertexOffset||0)*r;if(this.doublePrecision&&t instanceof Float64Array&&(t=(0,l.TK)(t,i)),this.settings.isIndexed){const e=this.settings.defaultType;t.constructor!==e&&(t=new e(t))}const a=t.byteLength+o+2*r;(!n||n.byteLength<a)&&(n=this._createBuffer(a)),n.write(t,o)}return this.setAccessor(i),!0}updateSubBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.state.bounds=null;const e=this.value,{startOffset:s=0,endOffset:n}=t;this.buffer.write(this.doublePrecision&&e instanceof Float64Array?(0,l.TK)(e,{size:this.size,startIndex:s,endIndex:n}):e.subarray(s,n),s*e.BYTES_PER_ELEMENT+this.byteOffset)}allocate(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{state:s}=this,n=s.allocatedValue,i=u.Z.allocate(n,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=i;const{byteOffset:r}=this;let{buffer:o}=this;return(!o||o.byteLength<i.byteLength+r)&&(o=this._createBuffer(i.byteLength+r),e&&n&&o.write(n instanceof Float64Array?(0,l.TK)(n,this):n,r)),s.allocatedValue=i,s.constant=!1,s.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(t){const{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const s=this.settings.defaultType;let n=!1;if(this.doublePrecision&&(n=e.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(e.constructor.name));e instanceof s||!this.settings.normalized||"normalized"in t||h.Z.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(t){switch(this.settings.type){case"snorm8":return new Float32Array(t).map((t=>(t+128)/255*2-1));case"snorm16":return new Float32Array(t).map((t=>(t+32768)/65535*2-1));case"unorm8":return new Float32Array(t).map((t=>t/255));case"unorm16":return new Float32Array(t).map((t=>t/65535));default:return t}}_normalizeValue(t,e,s){const{defaultValue:n,size:i}=this.settings;if(Number.isFinite(t))return e[s]=t,e;if(!t){let t=i;for(;--t>=0;)e[s+t]=n[t];return e}switch(i){case 4:e[s+3]=Number.isFinite(t[3])?t[3]:n[3];case 3:e[s+2]=Number.isFinite(t[2])?t[2]:n[2];case 2:e[s+1]=Number.isFinite(t[1])?t[1]:n[1];case 1:e[s+0]=Number.isFinite(t[0])?t[0]:n[0];break;default:let r=i;for(;--r>=0;)e[s+r]=Number.isFinite(t[r])?t[r]:n[r]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:s}=this;for(let n=0;n<s;n++)if(t[n]!==e[n])return!1;return!0}_createBuffer(t){var e;this._buffer&&this._buffer.destroy();const{isIndexed:s,type:i}=this.settings;return this._buffer=this.device.createBuffer({...null===(e=this._buffer)||void 0===e?void 0:e.props,id:this.id,usage:s?n.l.INDEX:n.l.VERTEX,indexType:s?i:void 0,byteLength:t}),this._buffer}}var p=s(27618);const g=[],_=[];function m(t){return t&&t[Symbol.asyncIterator]}var y=s(22612);const v=[],b=[[0,1/0]];const w={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function x(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});const s=t.type||"interpolation";return{...w[s],...e,...t,type:s}}class k extends f{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:b}),this.constant=!1,this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw(){let{clearChangedFlags:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}layoutChanged(){return this.state.layoutChanged}setAccessor(t){var e,s,n;(e=this.state).layoutChanged||(e.layoutChanged=(s=t,n=this.getAccessor(),!(s.type===n.type&&s.size===n.size&&c(s)===c(n)&&(s.offset||0)===(n.offset||0)))),super.setAccessor(t)}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat("function"!==typeof t&&t||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,s=this.settings.transition;return x(Array.isArray(e)?t[e.find((e=>t[e]))]:t[e],s)}setNeedsUpdate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.id,e=arguments.length>1?arguments[1]:void 0;if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:t=0,endRow:s=1/0}=e;this.state.updateRanges=function(t,e){if(t===b)return t;if(e[0]<0&&(e[0]=0),e[0]>=e[1])return t;const s=[],n=t.length;let i=0;for(let r=0;r<n;r++){const n=t[r];n[1]<e[0]?(s.push(n),i=r+1):n[0]>e[1]?s.push(n):e=[Math.min(n[0],e[0]),Math.max(n[1],e[1])]}return s.splice(i,0,e),s}(this.state.updateRanges,[t,s])}else this.state.updateRanges=b}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=v}setNeedsRedraw(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.id;this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){const{state:e,settings:s}=this;return!s.noAlloc&&(!!s.update&&(super.allocate(t,e.updateRanges!==b),!0))}updateBuffer(t){let{numInstances:e,data:s,props:n,context:i}=t;if(!this.needsUpdate())return!1;const{state:{updateRanges:r},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[t,a]of r)o.call(i,this,{data:s,startRow:t,endRow:a,props:n,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[t,s]of r){const n=Number.isFinite(t)?this.getVertexOffset(t):0,i=Number.isFinite(s)?this.getVertexOffset(s):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:n,endOffset:i})}else;this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(t){if(void 0===t||"function"===typeof t)return!1;return this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const{state:s,settings:n}=this;if(!t)return s.binaryValue=null,s.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(s.binaryValue===t)return this.clearNeedsUpdate(),!0;s.binaryValue=t,this.setNeedsRedraw();if(n.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});const i=t;(0,p.Z)(ArrayBuffer.isView(i.value),"invalid ".concat(n.accessor));const r=Boolean(i.size)&&i.size!==this.size;return s.binaryAccessor=function(t,e){const{size:s,stride:n,offset:i,startIndices:r,nested:o}=e,a=t.BYTES_PER_ELEMENT,c=n?n/a:s,u=i?i/a:0,l=Math.floor((t.length-u)/c);return(e,n)=>{let{index:i,target:a}=n;if(!r){const e=i*c+u;for(let n=0;n<s;n++)a[n]=t[e+n];return a}const h=r[i],d=r[i+1]||l;let f;if(o){f=new Array(d-h);for(let e=h;e<d;e++){const n=e*c+u;a=new Array(s);for(let e=0;e<s;e++)a[e]=t[n+e];f[e-h]=a}}else if(c===s)f=t.subarray(h*s+u,d*s+u);else{f=new t.constructor((d-h)*s);let e=0;for(let n=h;n<d;n++){const i=n*c+u;for(let n=0;n<s;n++)f[e++]=t[i+n]}}return f}}(i.value,{size:i.size||this.size,stride:i.stride,offset:i.offset,startIndices:e,nested:r}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getValue(){const t=this.settings.shaderAttributes,e=super.getValue();if(!t)return e;for(const s in t)Object.assign(e,super.getValue(s,t[s]));return e}getBufferLayout(t){this.state.layoutChanged=!1;const e=this.settings.shaderAttributes,s=super._getBufferLayout(),{stepMode:n}=this.settings;if(s.stepMode="dynamic"===n?t?t.isInstanced?"instance":"vertex":"instance":null!==n&&void 0!==n?n:"vertex",!e)return s;for(const i in e){const t=super._getBufferLayout(i,e[i]);s.attributes.push(...t.attributes)}return s}_autoUpdater(t,e){let{data:s,startRow:n,endRow:i,props:r,numInstances:o}=e;if(t.constant)return;const{settings:a,state:c,value:u,size:l,startIndices:h}=t,{accessor:d,transform:f}=a,m=c.binaryAccessor||("function"===typeof d?d:r[d]);(0,p.Z)("function"===typeof m,'accessor "'.concat(d,'" is not a function'));let v=t.getVertexOffset(n);const{iterable:b,objectInfo:w}=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,n=g;const i={index:-1,data:t,target:[]};return t?"function"===typeof t[Symbol.iterator]?n=t:t.length>0&&(_.length=t.length,n=_):n=g,(e>0||Number.isFinite(s))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,s),i.index=e-1),{iterable:n,objectInfo:i}}(s,n,i);for(const p of b){w.index++;let e=m(p,w);if(f&&(e=f.call(this,e)),h){const s=(w.index<h.length-1?h[w.index+1]:o)-h[w.index];if(e&&Array.isArray(e[0])){let s=v;for(const n of e)t._normalizeValue(n,u,s),s+=l}else e&&e.length>l?u.set(e,v):(t._normalizeValue(e,w.target,0),(0,y.k)({target:u,source:w.target,start:v,count:s}));v+=s*l}else t._normalizeValue(e,u,v),v+=l}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||"function"===typeof t.update))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let s=!0;switch(e){case 4:s=s&&Number.isFinite(t[3]);case 3:s=s&&Number.isFinite(t[2]);case 2:s=s&&Number.isFinite(t[1]);case 1:s=s&&Number.isFinite(t[0]);break;default:s=!1}if(!s)throw new Error("Illegal attribute generated for ".concat(this.id))}}}var A=s(96926),T=s(5578),P=s(31916),S=s(3540);const C="#version 300 es\n".concat("out vec4 transform_output;\nvoid main() {\ntransform_output = vec4(0);\n}");function E(t){const{input:e,inputChannels:s,output:n}=t||{};if(!e)return C;if(!s)throw new Error("inputChannels");const i=function(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error("invalid channels: ".concat(t))}}(s),r=function(t,e){switch(e){case 1:return"vec4(".concat(t,", 0.0, 0.0, 1.0)");case 2:return"vec4(".concat(t,", 0.0, 1.0)");case 3:return"vec4(".concat(t,", 1.0)");case 4:return t;default:throw new Error("invalid channels: ".concat(e))}}(e,s);return"#version 300 es\nin ".concat(i," ").concat(e,";\nout vec4 ").concat(n,";\nvoid main() {\n  ").concat(n," = ").concat(r,";\n}")}var I=s(31910);class L{static isSupported(t){var e;return"webgl"===(null===t||void 0===t||null===(e=t.info)||void 0===e?void 0:e.type)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I.H.defaultProps;(0,P.Z)(this,"device",void 0),(0,P.Z)(this,"model",void 0),(0,P.Z)(this,"transformFeedback",void 0),(0,S.h)(L.isSupported(t),"BufferTransform not yet implemented on WebGPU"),this.device=t,this.model=new I.H(this.device,{id:e.id||"buffer-transform-model",fs:e.fs||E(),topology:e.topology||"point-list",...e}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:e.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(t){const e=this.device.beginRenderPass(t);this.model.draw(e),e.end()}update(){console.warn("TextureTransform#update() not implemented")}getBuffer(t){return this.transformFeedback.getBuffer(t)}readAsync(t){const e=this.getBuffer(t);if(e instanceof n.l)return e.readAsync();const{buffer:s,byteOffset:i=0,byteLength:r=s.byteLength}=e;return s.readAsync(i,r)}}function O(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=Math.fround(t),i=t-n;return e[s]=n,e[s+1]=i,e}function R(t){return t-Math.fround(t)}function N(t){const e=new Float32Array(32);for(let s=0;s<4;++s)for(let n=0;n<4;++n){const i=4*s+n;O(t[4*n+s],e,2*i)}return e}const M={ONE:1};const U={name:"fp64-arithmetic",vs:"uniform float ONE;\nvec2 split(float a) {\nconst float SPLIT = 4097.0;\nfloat t = a * SPLIT;\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nfloat a_hi = t * ONE - (t - a);\nfloat a_lo = a * ONE - a_hi;\n#else\nfloat a_hi = t - (t - a);\nfloat a_lo = a - a_hi;\n#endif\nreturn vec2(a_hi, a_lo);\n}\nvec2 split2(vec2 a) {\nvec2 b = split(a.x);\nb.y += a.y;\nreturn b;\n}\nvec2 quickTwoSum(float a, float b) {\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nfloat sum = (a + b) * ONE;\nfloat err = b - (sum - a) * ONE;\n#else\nfloat sum = a + b;\nfloat err = b - (sum - a);\n#endif\nreturn vec2(sum, err);\n}\nvec2 twoSum(float a, float b) {\nfloat s = (a + b);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nfloat v = (s * ONE - a) * ONE;\nfloat err = (a - (s - v) * ONE) * ONE * ONE * ONE + (b - v);\n#else\nfloat v = s - a;\nfloat err = (a - (s - v)) + (b - v);\n#endif\nreturn vec2(s, err);\n}\nvec2 twoSub(float a, float b) {\nfloat s = (a - b);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nfloat v = (s * ONE - a) * ONE;\nfloat err = (a - (s - v) * ONE) * ONE * ONE * ONE - (b + v);\n#else\nfloat v = s - a;\nfloat err = (a - (s - v)) - (b + v);\n#endif\nreturn vec2(s, err);\n}\nvec2 twoSqr(float a) {\nfloat prod = a * a;\nvec2 a_fp64 = split(a);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nfloat err = ((a_fp64.x * a_fp64.x - prod) * ONE + 2.0 * a_fp64.x *\na_fp64.y * ONE * ONE) + a_fp64.y * a_fp64.y * ONE * ONE * ONE;\n#else\nfloat err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;\n#endif\nreturn vec2(prod, err);\n}\nvec2 twoProd(float a, float b) {\nfloat prod = a * b;\nvec2 a_fp64 = split(a);\nvec2 b_fp64 = split(b);\nfloat err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +\na_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;\nreturn vec2(prod, err);\n}\nvec2 sum_fp64(vec2 a, vec2 b) {\nvec2 s, t;\ns = twoSum(a.x, b.x);\nt = twoSum(a.y, b.y);\ns.y += t.x;\ns = quickTwoSum(s.x, s.y);\ns.y += t.y;\ns = quickTwoSum(s.x, s.y);\nreturn s;\n}\nvec2 sub_fp64(vec2 a, vec2 b) {\nvec2 s, t;\ns = twoSub(a.x, b.x);\nt = twoSub(a.y, b.y);\ns.y += t.x;\ns = quickTwoSum(s.x, s.y);\ns.y += t.y;\ns = quickTwoSum(s.x, s.y);\nreturn s;\n}\nvec2 mul_fp64(vec2 a, vec2 b) {\nvec2 prod = twoProd(a.x, b.x);\nprod.y += a.x * b.y;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\nprod = split2(prod);\n#endif\nprod = quickTwoSum(prod.x, prod.y);\nprod.y += a.y * b.x;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\nprod = split2(prod);\n#endif\nprod = quickTwoSum(prod.x, prod.y);\nreturn prod;\n}\nvec2 div_fp64(vec2 a, vec2 b) {\nfloat xn = 1.0 / b.x;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\nvec2 yn = mul_fp64(a, vec2(xn, 0));\n#else\nvec2 yn = a * xn;\n#endif\nfloat diff = (sub_fp64(a, mul_fp64(b, yn))).x;\nvec2 prod = twoProd(xn, diff);\nreturn sum_fp64(yn, prod);\n}\nvec2 sqrt_fp64(vec2 a) {\nif (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);\nif (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);\nfloat x = 1.0 / sqrt(a.x);\nfloat yn = a.x * x;\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\nvec2 yn_sqr = twoSqr(yn) * ONE;\n#else\nvec2 yn_sqr = twoSqr(yn);\n#endif\nfloat diff = sub_fp64(a, yn_sqr).x;\nvec2 prod = twoProd(x * 0.5, diff);\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\nreturn sum_fp64(split(yn), prod);\n#else\nreturn sum_fp64(vec2(yn, 0.0), prod);\n#endif\n}\n",getUniforms:function(){return M},fp64ify:O,fp64LowPart:R,fp64ifyMatrix4:N};function F(t){const{source:e,target:s,start:n=0,size:i,getData:r}=t,o=t.end||s.length,a=e.length,c=o-n;if(a>c)return void s.set(e.subarray(0,c),n);if(s.set(e,n),!r)return;let u=a;for(;u<c;){const t=r(u,e);for(let e=0;e<i;e++)s[n+u]=t[e]||0,u++}}function B(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(t,'"'))}}function z(t){switch(t){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function j(t){t.push(t.shift())}function D(t){let{device:e,source:s,target:n}=t;var i;(!n||n.byteLength<s.byteLength)&&(null===(i=n)||void 0===i||i.destroy(),n=e.createBuffer({byteLength:s.byteLength,usage:s.usage}));return n}function Z(t){let{device:e,buffer:s,attribute:n,fromLength:i,toLength:r,fromStartIndices:o,getData:a=(t=>t)}=t;const c=n.doublePrecision&&n.value instanceof Float64Array?2:1,u=n.size*c,l=n.byteOffset,h=n.settings.bytesPerElement<4?l/n.settings.bytesPerElement*4:l,d=n.startIndices,f=o&&d,p=n.isConstant;if(!f&&s&&i>=r)return s;const g=n.value instanceof Float64Array?Float32Array:n.value.constructor,_=p?n.value:new g(n.getBuffer().readSyncWebGL(l,r*g.BYTES_PER_ELEMENT).buffer);if(n.settings.normalized&&!p){const t=a;a=(e,s)=>n.normalizeConstant(t(e,s))}const m=p?(t,e)=>a(_,e):(t,e)=>a(_.subarray(t+l,t+l+u),e),y=s?new Float32Array(s.readSyncWebGL(h,4*i).buffer):new Float32Array(0),v=new Float32Array(r);var b;(function(t){let{source:e,target:s,size:n,getData:i,sourceStartIndices:r,targetStartIndices:o}=t;if(!r||!o)return F({source:e,target:s,size:n,getData:i}),s;let a=0,c=0;const u=i&&((t,e)=>i(t+c,e)),l=Math.min(r.length,o.length);for(let h=1;h<l;h++){const t=r[h]*n,i=o[h]*n;F({source:e.subarray(a,t),target:s,start:c,end:i,size:n,getData:u}),a=t,c=i}c<s.length&&F({source:[],target:s,start:c,size:n,getData:u})}({source:y,target:v,sourceStartIndices:o,targetStartIndices:d,size:u,getData:m}),!s||s.byteLength<v.byteLength+h)&&(null===(b=s)||void 0===b||b.destroy(),s=e.createBuffer({byteLength:v.byteLength+h,usage:35050}));return s.write(v,h),s}var V=s(91155);class q{constructor(t){let{device:e,attribute:s,timeline:n}=t;this.buffers=[],this.currentLength=0,this.device=e,this.transition=new V.Z(n),this.attribute=s,this.attributeInTransition=function(t){const{device:e,settings:s,value:n}=t,i=new k(e,s);return i.setData({value:n instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:s.normalized}),i}(s),this.currentStartIndices=s.startIndices}get inProgress(){return this.transition.inProgress}start(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;this.settings=t,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(t,e){const{doublePrecision:s,settings:n,value:i,size:r}=t,o=s&&i instanceof Float64Array?2:1;let a=0;const{shaderAttributes:c}=t.settings;if(c)for(const l of Object.values(c)){var u;a=Math.max(a,null!==(u=l.vertexOffset)&&void 0!==u?u:0)}return(n.noAlloc?i.length:(e+a)*r)*o}(this.attribute,e),this.transition.start({...t,duration:s})}update(){const t=this.transition.update();return t&&this.onUpdate(),t}setBuffer(t){this.attributeInTransition.setData({buffer:t,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const t of this.buffers)t.destroy();this.buffers.length=0}}const W="#version 300 es\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nuniform float time;\nin ATTRIBUTE_TYPE aFrom;\nin ATTRIBUTE_TYPE aTo;\nout ATTRIBUTE_TYPE vCurrent;\n\nvoid main(void) {\n  vCurrent = mix(aFrom, aTo, time);\n  gl_Position = vec4(0.0);\n}\n",G="#version 300 es\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nuniform float time;\nin ATTRIBUTE_TYPE aFrom;\nin ATTRIBUTE_TYPE aFrom64Low;\nin ATTRIBUTE_TYPE aTo;\nin ATTRIBUTE_TYPE aTo64Low;\nout ATTRIBUTE_TYPE vCurrent;\nout ATTRIBUTE_TYPE vCurrent64Low;\n\nvec2 mix_fp64(vec2 a, vec2 b, float x) {\n  vec2 range = sub_fp64(b, a);\n  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));\n}\n\nvoid main(void) {\n  for (int i=0; i<ATTRIBUTE_SIZE; i++) {\n    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), time);\n    vCurrent[i] = value.x;\n    vCurrent64Low[i] = value.y;\n  }\n  gl_Position = vec4(0.0);\n}\n";function H(t){return t.doublePrecision&&t.value instanceof Float64Array}const Y="#version 300 es\n#define SHADER_NAME spring-transition-vertex-shader\n\n#define EPSILON 0.00001\n\nuniform float stiffness;\nuniform float damping;\nin ATTRIBUTE_TYPE aPrev;\nin ATTRIBUTE_TYPE aCur;\nin ATTRIBUTE_TYPE aTo;\nout ATTRIBUTE_TYPE vNext;\nout float vIsTransitioningFlag;\n\nATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {\n  ATTRIBUTE_TYPE velocity = cur - prev;\n  ATTRIBUTE_TYPE delta = dest - cur;\n  ATTRIBUTE_TYPE spring = delta * stiffness;\n  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;\n  return spring + damper + velocity + cur;\n}\n\nvoid main(void) {\n  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;\n  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;\n\n  vNext = getNextValue(aCur, aPrev, aTo);\n  gl_Position = vec4(0, 0, 0, 1);\n  gl_PointSize = 100.0;\n}\n",K="#version 300 es\n#define SHADER_NAME spring-transition-is-transitioning-fragment-shader\n\nin float vIsTransitioningFlag;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vIsTransitioningFlag == 0.0) {\n    discard;\n  }\n  fragColor = vec4(1.0);\n}";const X={interpolation:class extends q{constructor(t){let{device:e,attribute:s,timeline:n}=t;super({device:e,attribute:s,timeline:n}),this.type="interpolation",this.transform=function(t,e){const s=e.size,n=B(s),i=z(s),r=e.getBufferLayout();if(H(e))return new L(t,{vs:G,bufferLayout:[{name:"aFrom",byteStride:8*s,attributes:[{attribute:"aFrom",format:i,byteOffset:0},{attribute:"aFrom64Low",format:i,byteOffset:4*s}]},{name:"aTo",byteStride:8*s,attributes:[{attribute:"aTo",format:i,byteOffset:0},{attribute:"aTo64Low",format:i,byteOffset:4*s}]}],modules:[U],defines:{ATTRIBUTE_TYPE:n,ATTRIBUTE_SIZE:s},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0});return new L(t,{vs:W,bufferLayout:[{name:"aFrom",format:i},{name:"aTo",format:r.attributes[0].format}],defines:{ATTRIBUTE_TYPE:n},varyings:["vCurrent"],disableWarnings:!0})}(e,s)}start(t,e){const s=this.currentLength,n=this.currentStartIndices;if(super.start(t,e,t.duration),t.duration<=0)return void this.transition.cancel();const{buffers:i,attribute:r}=this;j(i),i[0]=Z({device:this.device,buffer:i[0],attribute:r,fromLength:s,toLength:this.currentLength,fromStartIndices:n,getData:t.enter}),i[1]=D({device:this.device,source:i[0],target:i[1]}),this.setBuffer(i[1]);const{transform:o}=this,a=o.model;let c=Math.floor(this.currentLength/r.size);H(r)&&(c/=2),a.setVertexCount(c),r.isConstant?(a.setAttributes({aFrom:i[0]}),a.setConstantAttributes({aTo:r.value})):a.setAttributes({aFrom:i[0],aTo:r.getBuffer()}),o.transformFeedback.setBuffers({vCurrent:i[1]})}onUpdate(){const{duration:t,easing:e}=this.settings,{time:s}=this.transition;let n=s/t;e&&(n=e(n));const{model:i}=this.transform;i.setUniforms({time:n}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}},spring:class extends q{constructor(t){let{device:e,attribute:s,timeline:n}=t;super({device:e,attribute:s,timeline:n}),this.type="spring",this.texture=function(t){return t.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}(e),this.framebuffer=function(t,e){return t.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}(e,this.texture),this.transform=function(t,e){const s=B(e.size),n=z(e.size);return new L(t,{vs:Y,fs:K,bufferLayout:[{name:"aPrev",format:n},{name:"aCur",format:n},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],defines:{ATTRIBUTE_TYPE:s},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(e,s)}start(t,e){const s=this.currentLength,n=this.currentStartIndices;super.start(t,e);const{buffers:i,attribute:r}=this;for(let a=0;a<2;a++)i[a]=Z({device:this.device,buffer:i[a],attribute:r,fromLength:s,toLength:this.currentLength,fromStartIndices:n,getData:t.enter});i[2]=D({device:this.device,source:i[0],target:i[2]}),this.setBuffer(i[1]);const{model:o}=this.transform;o.setVertexCount(Math.floor(this.currentLength/r.size)),r.isConstant?o.setConstantAttributes({aTo:r.value}):o.setAttributes({aTo:r.getBuffer()})}onUpdate(){const{buffers:t,transform:e,framebuffer:s,transition:n}=this,i=this.settings;e.model.setAttributes({aPrev:t[0],aCur:t[1]}),e.transformFeedback.setBuffers({vNext:t[2]}),e.model.setUniforms({stiffness:i.stiffness,damping:i.damping}),e.run({framebuffer:s,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),j(t),this.setBuffer(t[1]);this.device.readPixelsToArrayWebGL(s)[0]>0||n.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}};class J{constructor(t,e){let{id:s,timeline:n}=e;if(!t)throw new Error("AttributeTransitionManager is constructed without device");this.id=s,this.device=t,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const t in this.transitions)this._removeTransition(t)}update(t){let{attributes:e,transitions:s,numInstances:n}=t;this.numInstances=n||1;for(const i in e){const t=e[i],n=t.getTransitionSetting(s);n&&this._updateAttribute(i,t,n)}for(const i in this.transitions){const t=e[i];t&&t.getTransitionSetting(s)||this._removeTransition(i)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const s=this.transitions[e];s.inProgress&&(t[e]=s.attributeInTransition)}return t}run(){if(0===this.numInstances)return!1;for(const e in this.transitions){this.transitions[e].update()&&(this.needsRedraw=!0)}const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].delete(),delete this.transitions[t]}_updateAttribute(t,e,s){const n=this.transitions[t];let i=!n||n.type!==s.type;if(i){n&&this._removeTransition(t);const r=X[s.type];r?this.transitions[t]=new r({attribute:e,timeline:this.timeline,device:this.device}):(h.Z.error("unsupported transition type '".concat(s.type,"'"))(),i=!1)}(i||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(s,this.numInstances))}}const Q="attributeManager.invalidate";class ${constructor(t){let{id:e="attribute-manager",stats:s,timeline:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.mergeBoundsMemoized=(0,A.Z)(l.cc),this.id=e,this.device=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=s,this.attributeTransitionManager=new J(t,{id:"".concat(e,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{clearRedrawFlags:!1};const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{stepMode:"instance"})}remove(t){for(const e of t)void 0!==this.attributes[e]&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){const s=this._invalidateTrigger(t,e);(0,T.Z)(Q,this,t,s)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);(0,T.Z)(Q,this,"all")}update(t){let{data:e,numInstances:s,startIndices:n=null,transitions:i,props:r={},buffers:o={},context:a={}}=t,c=!1;(0,T.Z)("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const u in this.attributes){const t=this.attributes[u],i=t.settings.accessor;t.startIndices=n,t.numInstances=s,r[u]&&h.Z.removed("props.".concat(u),"data.attributes.".concat(u))(),t.setExternalBuffer(o[u])||t.setBinaryValue("string"===typeof i?o[i]:void 0,e.startIndices)||"string"===typeof i&&!o[i]&&t.setConstantValue(r[i])||t.needsUpdate()&&(c=!0,this._updateAttribute({attribute:t,numInstances:s,data:e,props:r,context:a})),this.needsRedraw=this.needsRedraw||t.needsRedraw()}c&&(0,T.Z)("attributeManager.updateEnd",this,s),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:s,transitions:i})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(t){const e=t.map((t=>{var e;return null===(e=this.attributes[t])||void 0===e?void 0:e.getBounds()}));return this.mergeBoundsMemoized(e)}getChangedAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{clearChangedFlags:!1};const{attributes:e,attributeTransitionManager:s}=this,n={...s.getAttributes()};for(const i in e){const r=e[i];r.needsRedraw(t)&&!s.hasAttribute(i)&&(n[i]=r)}return n}getBufferLayouts(t){return Object.values(this.getAttributes()).map((e=>e.getBufferLayout(t)))}_add(t,e){for(const s in t){const n=t[s],i={...n,id:s,size:(n.isIndexed?1:n.size)||1,...e};this.attributes[s]=new k(this.device,i)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes){this.attributes[e].getUpdateTriggers().forEach((s=>{t[s]||(t[s]=[]),t[s].push(e)}))}this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:s,updateTriggers:n}=this,i=n[t];return i&&i.forEach((t=>{const n=s[t];n&&n.setNeedsUpdate(n.id,e)})),i}_updateAttribute(t){const{attribute:e,numInstances:s}=t;if((0,T.Z)("attribute.updateStart",e),e.constant)return void e.setConstantValue(e.value);e.allocate(s)&&(0,T.Z)("attribute.allocate",e,s);e.updateBuffer(t)&&(this.needsRedraw=!0,(0,T.Z)("attribute.updateEnd",e,s))}}var tt=s(24541);class et extends V.Z{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:s,duration:n,easing:i}}=this,r=i(t/n);this._value=(0,tt.t7)(e,s,r)}}const st=1e-5;function nt(t,e,s,n,i){const r=e-t;return(s-e)*i+-r*n+r+e}function it(t,e){if(Array.isArray(t)){let s=0;for(let n=0;n<t.length;n++){const i=t[n]-e[n];s+=i*i}return Math.sqrt(s)}return Math.abs(t-e)}class rt extends V.Z{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:s,stiffness:n}=this.settings,{_prevValue:i=t,_currValue:r=t}=this;let o=function(t,e,s,n,i){if(Array.isArray(s)){const r=[];for(let o=0;o<s.length;o++)r[o]=nt(t[o],e[o],s[o],n,i);return r}return nt(t,e,s,n,i)}(i,r,e,s,n);const a=it(o,e),c=it(o,r);a<st&&c<st&&(o=e,this.end()),this._prevValue=r,this._currValue=o}}const ot={interpolation:et,spring:rt};class at{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,s,n){const{transitions:i}=this;if(i.has(t)){const s=i.get(t),{value:n=s.settings.fromValue}=s;e=n,this.remove(t)}if(!(n=x(n)))return;const r=ot[n.type];if(!r)return void h.Z.error("unsupported transition type '".concat(n.type,"'"))();const o=new r(this.timeline);o.start({...n,fromValue:e,toValue:s}),i.set(t,o)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,s]of this.transitions)s.update(),t[e]=s.value,s.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}var ct=s(23029);function ut(t,e){const s=ht({newProps:t,oldProps:e,propTypes:t[ct.Wb],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=function(t,e){if(null===e)return"oldProps is null, initial diff";let s=!1;const{dataComparator:n,_dataDiff:i}=t;n?n(t.data,e.data)||(s="Data comparator detected a change"):t.data!==e.data&&(s="A new data container was supplied");s&&i&&(s=i(t.data,e.data)||s);return s}(t,e);let i=!1;return n||(i=function(t,e){if(null===e)return{all:!0};if("all"in t.updateTriggers){if(pt(t,e,"all"))return{all:!0}}const s={};let n=!1;for(const i in t.updateTriggers)if("all"!==i){pt(t,e,i)&&(s[i]=!0,n=!0)}return!!n&&s}(t,e)),{dataChanged:n,propsChanged:s,updateTriggersChanged:i,extensionsChanged:ft(t,e),transitionsChanged:lt(t,e)}}function lt(t,e){if(!t.transitions)return!1;const s={},n=t[ct.Wb];let i=!1;for(const r in t.transitions){const o=n[r],a=o&&o.type;("number"===a||"color"===a||"array"===a)&&dt(t[r],e[r],o)&&(s[r]=!0,i=!0)}return!!i&&s}function ht(t){let{newProps:e,oldProps:s,ignoreProps:n={},propTypes:i={},triggerName:r="props"}=t;if(s===e)return!1;if("object"!==typeof e||null===e)return"".concat(r," changed shallowly");if("object"!==typeof s||null===s)return"".concat(r," changed shallowly");for(const o of Object.keys(e))if(!(o in n)){if(!(o in s))return"".concat(r,".").concat(o," added");const t=dt(e[o],s[o],i[o]);if(t)return"".concat(r,".").concat(o," ").concat(t)}for(const o of Object.keys(s))if(!(o in n)){if(!(o in e))return"".concat(r,".").concat(o," dropped");if(!Object.hasOwnProperty.call(e,o)){const t=dt(e[o],s[o],i[o]);if(t)return"".concat(r,".").concat(o," ").concat(t)}}return!1}function dt(t,e,s){let n=s&&s.equal;return n&&!n(t,e,s)?"changed deeply":n||(n=t&&e&&t.equals,!n||n.call(t,e))?n||e===t?null:"changed shallowly":"changed deeply"}function ft(t,e){if(null===e)return!0;const s=e.extensions,{extensions:n}=t;if(n===s)return!1;if(!s||!n)return!0;if(n.length!==s.length)return!0;for(let i=0;i<n.length;i++)if(!n[i].equals(s[i]))return!0;return!1}function pt(t,e,s){let n=t.updateTriggers[s];n=void 0===n||null===n?{}:n;let i=e.updateTriggers[s];i=void 0===i||null===i?{}:i;return ht({oldProps:i,newProps:n,triggerName:s})}const gt="count(): argument not an object",_t="count(): argument not a container";function mt(t){if(null===(e=t)||"object"!==typeof e)throw new Error(gt);var e;if("function"===typeof t.count)return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(function(t){return null!==t&&"object"===typeof t&&t.constructor===Object}(t))return Object.keys(t).length;throw new Error(_t)}function yt(t,e){if(!e)return t;const s={...t,...e};if("defines"in e&&(s.defines={...t.defines,...e.defines}),"modules"in e&&(s.modules=(t.modules||[]).concat(e.modules),e.modules.some((t=>"project64"===t.name)))){const t=s.modules.findIndex((t=>"project32"===t.name));t>=0&&s.modules.splice(t,1)}if("inject"in e)if(t.inject){const n={...t.inject};for(const t in e.inject)n[t]=(n[t]||"")+e.inject[t];s.inject=n}else s.inject=e.inject;return s}var vt=s(81546),bt=s(74144),wt=s(54499),xt=s(43676),kt=s(91960);const At=[0,0,0];function Tt(t,e){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=e.projectPosition(t);if(s&&e instanceof bt.Z){const[s,i,r=0]=t,o=e.getDistanceScales([s,i]);n[2]=r*o.unitsPerMeter[2]}return n}function Pt(t,e){let{viewport:s,modelMatrix:n,coordinateSystem:r,coordinateOrigin:o,offsetMode:a}=e,[c,u,l=0]=t;switch(n&&([c,u,l]=wt.fF([],[c,u,l,1],n)),r){case i.Df.LNGLAT:return Tt([c,u,l],s,a);case i.Df.LNGLAT_OFFSETS:return Tt([c+o[0],u+o[1],l+(o[2]||0)],s,a);case i.Df.METER_OFFSETS:return Tt((0,kt.eG)(o,[c,u,l]),s,a);case i.Df.CARTESIAN:default:return s.isGeospatial?[c+o[0],u+o[1],l+o[2]]:s.projectPosition([c,u,l])}}function St(t,e){const{viewport:s,coordinateSystem:n,coordinateOrigin:r,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:c}=function(t){const{viewport:e,modelMatrix:s,coordinateOrigin:n}=t;let{coordinateSystem:r,fromCoordinateSystem:o,fromCoordinateOrigin:a}=t;return r===i.Df.DEFAULT&&(r=e.isGeospatial?i.Df.LNGLAT:i.Df.CARTESIAN),void 0===o&&(o=r),void 0===a&&(a=n),{viewport:e,coordinateSystem:r,coordinateOrigin:n,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}}(e),{autoOffset:u=!0}=e,{geospatialOrigin:l=At,shaderCoordinateOrigin:h=At,offsetMode:d=!1}=u?(0,vt.v)(s,n,r):{},f=Pt(t,{viewport:s,modelMatrix:o,coordinateSystem:a,coordinateOrigin:c,offsetMode:d});if(d){const t=s.projectPosition(l||h);xt.lu(f,f,t)}return f}var Ct=s(92310);const Et={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},It={};var Lt=s(70898);const Ot={boolean:{validate:(t,e)=>!0,equal:(t,e,s)=>Boolean(t)===Boolean(e)},number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},color:{validate:(t,e)=>e.optional&&!t||Mt(t)&&(3===t.length||4===t.length),equal:(t,e,s)=>(0,Lt.v)(t,e,1)},accessor:{validate(t,e){const s=Ut(t);return"function"===s||s===Ut(e.value)},equal:(t,e,s)=>"function"===typeof e||(0,Lt.v)(t,e,1)},array:{validate:(t,e)=>e.optional&&!t||Mt(t),equal(t,e,s){const{compare:n}=s,i=Number.isInteger(n)?n:n?1:0;return n?(0,Lt.v)(t,e,i):t===e}},object:{equal(t,e,s){if(s.ignore)return!0;const{compare:n}=s,i=Number.isInteger(n)?n:n?1:0;return n?(0,Lt.v)(t,e,i):t===e}},function:{validate:(t,e)=>e.optional&&!t||"function"===typeof t,equal:(t,e,s)=>!s.compare&&!1!==s.ignore||t===e},data:{transform:(t,e,s)=>{if(!t)return t;const{dataTransform:n}=s.props;return n?n(t):"string"===typeof t.shape&&t.shape.endsWith("-table")&&Array.isArray(t.data)?t.data:t}},image:{transform:(t,e,s)=>{const n=s.context;return n&&n.device?function(t,e,s,n){if(s instanceof Ct.x)return s;s.constructor&&"Object"!==s.constructor.name&&(s={data:s});let i=null;s.compressed&&(i={minFilter:"linear",mipmapFilter:s.data.length>1?"nearest":"linear"});const r=e.createTexture({...s,sampler:{...Et,...i,...n}});return It[r.id]=t,r}(s.id,n.device,t,{...e.parameters,...s.props.textureParameters}):null},release:(t,e,s)=>{var n,i;n=s.id,(i=t)&&i instanceof Ct.x&&It[i.id]===n&&(i.delete(),delete It[i.id])}}};function Rt(t,e){switch(Ut(e)){case"object":return Nt(t,e);case"array":return Nt(t,{type:"array",value:e,compare:!1});case"boolean":return Nt(t,{type:"boolean",value:e});case"number":return Nt(t,{type:"number",value:e});case"function":return Nt(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}function Nt(t,e){return"type"in e?{name:t,...Ot[e.type],...e}:"value"in e?{name:t,type:Ut(e.value),...e}:{name:t,type:"object",value:e}}function Mt(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function Ut(t){return Mt(t)?"array":null===t?"null":typeof t}const Ft="_mergedDefaultProps";function Bt(t,e){let s=Ft;if(e)for(const i of e){const t=i.constructor;t&&(s+=":".concat(t.extensionName||t.name))}const n=Dt(t,s);return n||(t[s]=function(t,e){const s=t.prototype;if(!s)return null;const n=Object.getPrototypeOf(t),i=Bt(n),r=Dt(t,"defaultProps")||{},o=function(t){const e={},s={},n={};for(const[i,r]of Object.entries(t)){const t=null===r||void 0===r?void 0:r.deprecatedFor;if(t)n[i]=Array.isArray(t)?t:[t];else{const t=Rt(i,r);e[i]=t,s[i]=t.value}}return{propTypes:e,defaultProps:s,deprecatedProps:n}}(r),a=Object.assign(Object.create(null),i,o.defaultProps),c=Object.assign(Object.create(null),null===i||void 0===i?void 0:i[ct.Wb],o.propTypes),u=Object.assign(Object.create(null),null===i||void 0===i?void 0:i[ct.E7],o.deprecatedProps);for(const l of e){const t=Bt(l.constructor);t&&(Object.assign(a,t),Object.assign(c,t[ct.Wb]),Object.assign(u,t[ct.E7]))}(function(t,e){const s=function(t){const e=t.componentName;e||h.Z.warn("".concat(t.name,".componentName not specified"))();return e||t.name}(e);Object.defineProperties(t,{id:{writable:!0,value:s}})})(a,t),function(t,e){const s={},n={};for(const i in e){const t=e[i],{name:r,value:o}=t;t.async&&(s[r]=o,n[r]=zt(r))}t[ct.lY]=s,t[ct.fO]={},Object.defineProperties(t,n)}(a,c),function(t,e){for(const s in e)Object.defineProperty(t,s,{enumerable:!1,set(t){const n="".concat(this.id,": ").concat(s);for(const i of e[s])jt(this,i)||(this[i]=t);h.Z.deprecated(n,e[s].join("/"))()}})}(a,u),a[ct.Wb]=c,a[ct.E7]=u,0!==e.length||jt(t,"_propTypes")||(t._propTypes=c);return a}(t,e||[]))}function zt(t){return{enumerable:!0,set(e){"string"===typeof e||e instanceof Promise||m(e)?this[ct.fO][t]=e:this[ct.bN][t]=e},get(){if(this[ct.bN]){if(t in this[ct.bN]){return this[ct.bN][t]||this[ct.lY][t]}if(t in this[ct.fO]){const e=this[ct.fm]&&this[ct.fm].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[ct.lY][t]}}return this[ct.lY][t]}}}function jt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Dt(t,e){return jt(t,e)&&t[e]}let Zt=0;class Vt{constructor(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.props=function(t,e){let s;for(let r=e.length-1;r>=0;r--){const t=e[r];"extensions"in t&&(s=t.extensions)}const n=Bt(t.constructor,s),i=Object.create(n);i[ct.fm]=t,i[ct.fO]={},i[ct.bN]={};for(let r=0;r<e.length;++r){const t=e[r];for(const e in t)i[e]=t[e]}return Object.freeze(i),i}(this,e),this.id=this.props.id,this.count=Zt++}clone(t){const{props:e}=this,s={};for(const n in e[ct.lY])n in e[ct.bN]?s[n]=e[ct.bN][n]:n in e[ct.fO]&&(s[n]=e[ct.fO][n]);return new this.constructor({...e,...s,...t})}}Vt.componentName="Component",Vt.defaultProps={};const qt=Object.freeze({});class Wt{constructor(t){this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||qt}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return Boolean(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[ct.fm]||this.component;const e=t[ct.bN]||{},s=t[ct.fO]||t,n=t[ct.lY]||{};for(const i in e){const t=e[i];this._createAsyncPropData(i,n[i]),this._updateAsyncProp(i,t),e[i]=this.getAsyncProp(i)}for(const i in s){const t=s[i];this._createAsyncPropData(i,n[i]),this._updateAsyncProp(i,t)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){this._didAsyncInputValueChange(t,e)&&("string"===typeof e&&(e=this._fetch(t,e)),e instanceof Promise?this._watchPromise(t,e):m(e)?this._resolveAsyncIterable(t,e):this._setPropValue(t,e))}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){const s=this.asyncProps[t];return e!==s.resolvedValue&&e!==s.lastValue&&(s.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();const s=this.asyncProps[t];s&&(e=this._postProcessValue(s,e),s.resolvedValue=e,s.pendingLoadCount++,s.resolvedLoadCount=s.pendingLoadCount)}_setAsyncPropValue(t,e,s){const n=this.asyncProps[t];n&&s>=n.resolvedLoadCount&&void 0!==e&&(this._freezeAsyncOldProps(),n.resolvedValue=e,n.resolvedLoadCount=s,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const s=this.asyncProps[t];if(s){s.pendingLoadCount++;const n=s.pendingLoadCount;e.then((e=>{this.component&&(e=this._postProcessValue(s,e),this._setAsyncPropValue(t,e,n),this._onResolve(t,e))})).catch((e=>{this._onError(t,e)}))}}async _resolveAsyncIterable(t,e){if("data"!==t)return void this._setPropValue(t,e);const s=this.asyncProps[t];if(!s)return;s.pendingLoadCount++;const n=s.pendingLoadCount;let i=[],r=0;for await(const o of e){if(!this.component)return;const{dataTransform:e}=this.component.props;i=e?e(o,i):i.concat(o),Object.defineProperty(i,"__diff",{enumerable:!1,value:[{startRow:r,endRow:i.length}]}),r=i.length,this._setAsyncPropValue(t,i,n)}this._onResolve(t,i)}_postProcessValue(t,e){const s=t.type;return s&&this.component&&(s.release&&s.release(t.resolvedValue,s,this.component),s.transform)?s.transform(e,s,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const s=this.component&&this.component.props[ct.Wb];this.asyncProps[t]={type:s&&s[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}class Gt extends Wt{constructor(t){let{attributeManager:e,layer:s}=t;super(s),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){const s=this.layer,n=null===s||void 0===s?void 0:s.props.fetch;return n?n(e,{propName:t,layer:s}):super._fetch(t,e)}_onResolve(t,e){const s=this.layer;if(s){const n=s.props.onDataLoad;"data"===t&&n&&n(e,{propName:t,layer:s})}}_onError(t,e){const s=this.layer;s&&s.raiseError(e,"loading ".concat(t," of ").concat(this.layer))}}var Ht=s(82903);const Yt=2**24-1,Kt=Object.freeze([]),Xt=(0,A.Z)((t=>{let{oldViewport:e,viewport:s}=t;return e.equals(s)}));let Jt=new Uint8ClampedArray(0);const Qt={data:{type:"data",value:Kt,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,e)=>{let{propName:s,layer:n,loaders:i,loadOptions:r,signal:o}=e;const{resourceManager:a}=n.context;var c;(r=r||n.getLoadOptions(),i=i||n.props.loaders,o)&&(r={...r,fetch:{...null===(c=r)||void 0===c?void 0:c.fetch,signal:o}});let u=a.contains(t);return u||r||(a.add({resourceId:t,data:(0,Ht.z)(t,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:t,onChange:t=>{var e;return null===(e=n.internalState)||void 0===e?void 0:e.reloadAsyncProp(s,t)},consumerId:n.id,requestId:s}):(0,Ht.z)(t,i,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:i.Df.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:t=>{let{layerIndex:e}=t;return[0,100*-e]}},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class $t extends Vt{constructor(){super(...arguments),this.internalState=null,this.lifecycle=ct.dt.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){const t=this.constructor.layerName||this.constructor.name;return"".concat(t,"({id: '").concat(this.props.id,"'})")}project(t){(0,p.Z)(this.internalState);const e=this.internalState.viewport||this.context.viewport,s=Pt(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,i,r]=(0,kt.aW)(s,e.pixelProjectionMatrix);return 2===t.length?[n,i]:[n,i,r]}unproject(t){(0,p.Z)(this.internalState);return(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){(0,p.Z)(this.internalState);return St(t,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const t=this.state;return t&&(t.models||t.model&&[t.model])||[]}setModuleParameters(t){for(const e of this.getModels())e.updateModuleSettings(t)}setShaderModuleProps(){for(const t of this.getModels())t.shaderInputs.setProps(...arguments)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===i.Df.DEFAULT||t===i.Df.LNGLAT||t===i.Df.CARTESIAN}onHover(t,e){return this.props.onHover&&this.props.onHover(t,e)||!1}onClick(t,e){return this.props.onClick&&this.props.onClick(t,e)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){(0,p.Z)(t instanceof Uint8Array);const[e,s,n]=t;return e+256*s+65536*n-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:mt(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["positions","instancePositions"])}getShaders(t){t=yt(t,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const e of this.props.extensions)t=yt(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){const e=this.getAttributeManager(),{dataChanged:s}=t.changeFlags;if(s&&e)if(Array.isArray(s))for(const n of s)e.invalidateAll(n);else e.invalidateAll();if(e){const{props:s}=t,n=this.internalState.hasPickingBuffer,i=Number.isInteger(s.highlightedObjectIndex)||s.pickable||s.extensions.some((t=>t.getNeedsPickingBuffer.call(this,t)));if(n!==i){this.internalState.hasPickingBuffer=i;const{pickingColors:t,instancePickingColors:s}=e.attributes,n=t||s;n&&(i&&n.constant&&(n.constant=!1,e.invalidate(n.id)),n.value||i||(n.constant=!0,n.value=[0,0,0]))}}}finalizeState(t){for(const s of this.getModels())s.destroy();const e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(const e of this.getModels())e.draw(t)}getPickingInfo(t){let{info:e,mode:s,sourceLayer:n}=t;const{index:i}=e;return i>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[i]),e}raiseError(t,e){var s,n,i,r;(e&&(t=new Error("".concat(e,": ").concat(t.message),{cause:t})),null!==(s=(n=this.props).onError)&&void 0!==s&&s.call(n,t))||(null===(i=this.context)||void 0===i||null===(r=i.onError)||void 0===r||r.call(i,t,this))}getNeedsRedraw(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{clearRedrawFlags:!1};return this._getNeedsRedraw(t)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var t;return(null===(t=this.internalState)||void 0===t?void 0:t.uniformTransitions.active)||!1}activateViewport(t){if(!this.internalState)return;const e=this.internalState.viewport;this.internalState.viewport=t,e&&Xt({oldViewport:e,viewport:t})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"all";const e=this.getAttributeManager();e&&("all"===t?e.invalidateAll():e.invalidate(t))}updateAttributes(t){let e=!1;for(const s in t)t[s].layoutChanged()&&(e=!0);for(const s of this.getModels())this._setModelAttributes(s,t,e)}_updateAttributes(){const t=this.getAttributeManager();if(!t)return;const e=this.props,s=this.getNumInstances(),n=this.getStartIndices();t.update({data:e.data,numInstances:s,startIndices:n,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});const i=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(i)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),s=Object.create(this.props);for(const t in e)Object.defineProperty(s,t,{value:e[t]});return s}return this.props}calculateInstancePickingColors(t,e){let{numInstances:s}=e;if(t.constant)return;const n=Math.floor(Jt.length/4);if(this.internalState.usesPickingColorCache=!0,n<s){s>Yt&&h.Z.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Jt=u.Z.allocate(Jt,s,{size:4,copy:!0,maxCount:Math.max(s,Yt)});const t=Math.floor(Jt.length/4),e=[];for(let s=n;s<t;s++)this.encodePickingColor(s,e),Jt[4*s+0]=e[0],Jt[4*s+1]=e[1],Jt[4*s+2]=e[2]}t.value=Jt.subarray(0,4*s)}_setModelAttributes(t,e){var s;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!Object.keys(e).length)return;if(i){const s=this.getAttributeManager();t.setBufferLayout(s.getBufferLayouts(t)),e=s.getAttributes()}const r=(null===(s=t.userData)||void 0===s?void 0:s.excludeAttributes)||{},o={},a={};for(const c in e){if(r[c])continue;const s=e[c].getValue();for(const i in s){const r=s[i];r instanceof n.l?e[c].settings.isIndexed?t.setIndexBuffer(r):o[i]=r:r&&(a[i]=r)}}t.setAttributes(o),t.setConstantAttributes(a)}disablePickingIndex(t){const e=this.props.data;if(!("attributes"in e))return void this._disablePickingIndex(t);const{pickingColors:s,instancePickingColors:n}=this.getAttributeManager().attributes,i=s||n,r=i&&e.attributes&&e.attributes[i.id];if(r&&r.value){const s=r.value,n=this.encodePickingColor(t);for(let t=0;t<e.length;t++){const e=i.getVertexOffset(t);s[e]===n[0]&&s[e+1]===n[1]&&s[e+2]===n[2]&&this._disablePickingIndex(t)}}else this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:s}=this.getAttributeManager().attributes,n=e||s;if(!n)return;const i=n.getVertexOffset(t),r=n.getVertexOffset(t+1);n.buffer.write(new Uint8Array(r-i),i)}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,s=t||e;s&&(this.internalState.usesPickingColorCache&&s.value.buffer!==Jt.buffer&&(s.value=Jt.subarray(0,s.value.length)),s.updateSubBuffer({startOffset:0}))}_initialize(){(0,p.Z)(!this.internalState),(0,p.Z)(Number.isFinite(this.props.coordinateSystem)),(0,T.Z)("layer.initialize",this);const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Gt({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(h.Z.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.uniformTransitions=new at(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){(0,T.Z)("layer.matched",this,this===t);const{state:e,internalState:s}=t;this!==t&&(this.internalState=s,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const t=this.needsUpdate();if((0,T.Z)("layer.update",this,t),!t)return;const e=this.props,s=this.context,n=this.internalState,i=s.viewport,r=this._updateUniformTransition();n.propsInTransition=r,s.viewport=n.viewport||i,this.props=r;try{const t=this._getUpdateParams(),r=this.getModels();if(s.device)this.updateState(t);else try{this.updateState(t)}catch(o){}for(const e of this.props.extensions)e.updateState.call(this,t,e);const a=this.getModels()[0]!==r[0];this._postUpdate(t,a)}finally{s.viewport=i,this.props=e,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){(0,T.Z)("layer.finalize",this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,this.context,t)}_drawLayer(t){let{renderPass:e,moduleParameters:s=null,uniforms:n={},parameters:i={}}=t;this._updateAttributeTransition();const r=this.props,o=this.context;this.props=this.internalState.propsInTransition||r;const a=this.props.opacity;n.opacity=Math.pow(a,1/2.2);try{if(s){const{isActive:t,isAttribute:e}=s.picking;this.setModuleParameters(s),this.setShaderModuleProps({picking:{isActive:t,isAttribute:e}})}const{getPolygonOffset:t}=this.props,a=t&&t(n)||[0,0];o.device.setParametersWebGL({polygonOffset:a});for(const e of this.getModels())e.setParameters(i);o.device.withParametersWebGL(i,(()=>{const t={renderPass:e,moduleParameters:s,uniforms:n,parameters:i,context:o};for(const e of this.props.extensions)e.draw.call(this,t,e);this.draw(t)}))}finally{this.props=r}}getChangeFlags(){var t;return null===(t=this.internalState)||void 0===t?void 0:t.changeFlags}setChangeFlags(t){if(!this.internalState)return;const{changeFlags:e}=this.internalState;for(const n in t)if(t[n]){let s=!1;if("dataChanged"===n){const i=t[n],r=e[n];i&&Array.isArray(r)&&(e.dataChanged=Array.isArray(i)?r.concat(i):i,s=!0)}e[n]||(e[n]=t[n],s=!0),s&&(0,T.Z)("layer.changeFlag",this,n,t)}const s=Boolean(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=s,e.somethingChanged=s||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){const s=ut(t,e);if(s.updateTriggersChanged)for(const i in s.updateTriggersChanged)s.updateTriggersChanged[i]&&this.invalidateAttribute(i);if(s.transitionsChanged)for(const i in s.transitionsChanged){var n;this.internalState.uniformTransitions.add(i,e[i],t[i],null===(n=t.transitions)||void 0===n?void 0:n[i])}return this.setChangeFlags(s)}validateProps(){!function(t){const e=t[ct.Wb];for(const s in e){const n=e[s],{validate:i}=n;if(i&&!i(t[s],n))throw new Error("Invalid prop ".concat(s,": ").concat(t[s]))}}(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={highlightedObjectColor:t.picked?t.color:null},{highlightColor:s}=this.props;t.picked&&"function"===typeof s&&(e.highlightColor=s(t)),this.setShaderModuleProps({picking:e}),this.setNeedsRedraw()}_getAttributeManager(){const t=this.context;return new $(t.device,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){const{props:s,oldProps:n}=t;this.setNeedsRedraw(),this._updateAttributes();const i=this.state.model;null!==i&&void 0!==i&&i.isInstanced&&i.setInstanceCount(this.getNumInstances());const{autoHighlight:r,highlightedObjectIndex:o,highlightColor:a}=s;if(e||n.autoHighlight!==r||n.highlightedObjectIndex!==o||n.highlightColor!==a){const t={};Array.isArray(a)&&(t.highlightColor=a),(e||n.autoHighlight!==r||o!==n.highlightedObjectIndex)&&(t.highlightedObjectColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setShaderModuleProps({picking:t})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id;const s=this.getAttributeManager(),n=!!s&&s.getNeedsRedraw(t);if(e=e||n,e)for(const i of this.props.extensions)i.onNeedsRedraw.call(this,i);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}$t.defaultProps=Qt,$t.layerName="Layer"},58016:(t,e,s)=>{s.d(e,{Z:()=>i});const n={name:"picking",vs:"uniform pickingUniforms {\nfloat isActive;\nfloat isAttribute;\nfloat isHighlightActive;\nfloat useFloatColors;\nvec3 highlightedObjectColor;\nvec4 highlightColor;\n} picking;\nout vec4 picking_vRGBcolor_Avalid;\nvec3 picking_normalizeColor(vec3 color) {\nreturn picking.useFloatColors > 0.5 ? color : color / 255.0;\n}\nvec4 picking_normalizeColor(vec4 color) {\nreturn picking.useFloatColors > 0.5 ? color : color / 255.0;\n}\nbool picking_isColorZero(vec3 color) {\nreturn dot(color, vec3(1.0)) < 0.00001;\n}\nbool picking_isColorValid(vec3 color) {\nreturn dot(color, vec3(1.0)) > 0.00001;\n}\nbool isVertexHighlighted(vec3 vertexColor) {\nvec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);\nreturn\nbool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));\n}\nvoid picking_setPickingColor(vec3 pickingColor) {\npickingColor = picking_normalizeColor(pickingColor);\nif (bool(picking.isActive)) {\npicking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));\nif (!bool(picking.isAttribute)) {\npicking_vRGBcolor_Avalid.rgb = pickingColor;\n}\n} else {\npicking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));\n}\n}\nvoid picking_setPickingAttribute(float value) {\nif (bool(picking.isAttribute)) {\npicking_vRGBcolor_Avalid.r = value;\n}\n}\nvoid picking_setPickingAttribute(vec2 value) {\nif (bool(picking.isAttribute)) {\npicking_vRGBcolor_Avalid.rg = value;\n}\n}\nvoid picking_setPickingAttribute(vec3 value) {\nif (bool(picking.isAttribute)) {\npicking_vRGBcolor_Avalid.rgb = value;\n}\n}\n",fs:"uniform pickingUniforms {\nfloat isActive;\nfloat isAttribute;\nfloat isHighlightActive;\nfloat useFloatColors;\nvec3 highlightedObjectColor;\nvec4 highlightColor;\n} picking;\nin vec4 picking_vRGBcolor_Avalid;\nvec4 picking_filterHighlightColor(vec4 color) {\nif (picking.isActive > 0.5) {\nreturn color;\n}\nbool selected = bool(picking_vRGBcolor_Avalid.a);\nif (selected) {\nfloat highLightAlpha = picking.highlightColor.a;\nfloat blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);\nfloat highLightRatio = highLightAlpha / blendedAlpha;\nvec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);\nreturn vec4(blendedRGB, blendedAlpha);\n} else {\nreturn color;\n}\n}\nvec4 picking_filterPickingColor(vec4 color) {\nif (bool(picking.isActive)) {\nif (picking_vRGBcolor_Avalid.a == 0.0) {\ndiscard;\n}\nreturn picking_vRGBcolor_Avalid;\n}\nreturn color;\n}\nvec4 picking_filterColor(vec4 color) {\nvec4 highlightColor = picking_filterHighlightColor(color);\nreturn picking_filterPickingColor(highlightColor);\n}\n",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:[0,1,1,1]},getUniforms:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e={};if(void 0===t.highlightedObjectColor);else if(null===t.highlightedObjectColor)e.isHighlightActive=!1;else{e.isHighlightActive=!0;const s=t.highlightedObjectColor.slice(0,3);e.highlightedObjectColor=s}if(t.highlightColor){const s=Array.from(t.highlightColor,(t=>t/255));Number.isFinite(s[3])||(s[3]=1),e.highlightColor=s}void 0!==t.isActive&&(e.isActive=Boolean(t.isActive),e.isAttribute=Boolean(t.isAttribute));void 0!==t.useFloatColors&&(e.useFloatColors=Boolean(t.useFloatColors));return e}};const i={...n,defaultUniforms:{...n.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    // for picking depth values\n    picking_setPickingAttribute(position.z / position.w);\n  ","vs:DECKGL_FILTER_COLOR":"\n  picking_setPickingColor(geometry.pickingColor);\n  ","fs:DECKGL_FILTER_COLOR":{order:99,injection:"\n  // use highlight color if this fragment belongs to the selected object.\n  color = picking_filterHighlightColor(color);\n\n  // use picking color if rendering to picking FBO.\n  color = picking_filterPickingColor(color);\n    "}}}},81333:(t,e,s)=>{s.d(e,{Z:()=>n});const n={name:"project32",dependencies:[s(35485).Z],vs:"\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition\n) {\n  vec3 projectedPosition = project_position(position, position64Low);\n  mat3 rotation;\n  if (project_needs_rotation(projectedPosition, rotation)) {\n    // offset is specified as ENU\n    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe\n    offset = rotation * offset;\n  }\n  commonPosition = vec4(projectedPosition + offset, 1.0);\n  return project_common_position_to_clipspace(commonPosition);\n}\n\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset\n) {\n  vec4 commonPosition;\n  return project_position_to_clipspace(position, position64Low, offset, commonPosition);\n}\n"}},87672:(t,e,s)=>{s.d(e,{Z:()=>h});var n=s(51215),i=s(81333),r=s(58016),o=s(6955),a=s(99248),c=s(31910);const u=[0,0,0,255],l={getSourcePosition:{type:"accessor",value:t=>t.sourcePosition},getTargetPosition:{type:"accessor",value:t=>t.targetPosition},getSourceColor:{type:"accessor",value:u},getTargetColor:{type:"accessor",value:u},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class h extends n.Z{getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME arc-layer-vertex-shader\nin vec3 positions;\nin vec4 instanceSourceColors;\nin vec4 instanceTargetColors;\nin vec3 instanceSourcePositions;\nin vec3 instanceSourcePositions64Low;\nin vec3 instanceTargetPositions;\nin vec3 instanceTargetPositions64Low;\nin vec3 instancePickingColors;\nin float instanceWidths;\nin float instanceHeights;\nin float instanceTilts;\nuniform bool greatCircle;\nuniform bool useShortestPath;\nuniform float numSegments;\nuniform float opacity;\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform int widthUnits;\nout vec4 vColor;\nout vec2 uv;\nout float isValid;\nfloat paraboloid(float distance, float sourceZ, float targetZ, float ratio) {\nfloat deltaZ = targetZ - sourceZ;\nfloat dh = distance * instanceHeights;\nif (dh == 0.0) {\nreturn sourceZ + deltaZ * ratio;\n}\nfloat unitZ = deltaZ / dh;\nfloat p2 = unitZ * unitZ + 1.0;\nfloat dir = step(deltaZ, 0.0);\nfloat z0 = mix(sourceZ, targetZ, dir);\nfloat r = mix(ratio, 1.0 - ratio, dir);\nreturn sqrt(r * (p2 - r)) * dh + z0;\n}\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {\nvec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);\ndir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\nreturn dir_screenspace * offset_direction * width / 2.0;\n}\nfloat getSegmentRatio(float index) {\nreturn smoothstep(0.0, 1.0, index / (numSegments - 1.0));\n}\nvec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {\nfloat distance = length(source.xy - target.xy);\nfloat z = paraboloid(distance, source.z, target.z, segmentRatio);\nfloat tiltAngle = radians(instanceTilts);\nvec2 tiltDirection = normalize(target.xy - source.xy);\nvec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);\nreturn vec3(\nmix(source.xy, target.xy, segmentRatio) + tilt,\nz * cos(tiltAngle)\n);\n}\nfloat getAngularDist (vec2 source, vec2 target) {\nvec2 sourceRadians = radians(source);\nvec2 targetRadians = radians(target);\nvec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);\nvec2 shd_sq = sin_half_delta * sin_half_delta;\nfloat a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;\nreturn 2.0 * asin(sqrt(a));\n}\nvec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {\nvec2 lngLat;\nif(abs(angularDist - PI) < 0.001) {\nlngLat = (1.0 - t) * source.xy + t * target.xy;\n} else {\nfloat a = sin((1.0 - t) * angularDist);\nfloat b = sin(t * angularDist);\nvec3 p = source3D.yxz * a + target3D.yxz * b;\nlngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));\n}\nfloat z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);\nreturn vec3(lngLat, z);\n}\nvoid main(void) {\ngeometry.worldPosition = instanceSourcePositions;\ngeometry.worldPositionAlt = instanceTargetPositions;\nfloat segmentIndex = positions.x;\nfloat segmentRatio = getSegmentRatio(segmentIndex);\nfloat prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));\nfloat nextSegmentRatio = getSegmentRatio(min(numSegments - 1.0, segmentIndex + 1.0));\nfloat indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));\nisValid = 1.0;\nuv = vec2(segmentRatio, positions.y);\ngeometry.uv = uv;\ngeometry.pickingColor = instancePickingColors;\nvec4 curr;\nvec4 next;\nvec3 source;\nvec3 target;\nif ((greatCircle || project_uProjectionMode == PROJECTION_MODE_GLOBE) && project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\nsource = project_globe_(vec3(instanceSourcePositions.xy, 0.0));\ntarget = project_globe_(vec3(instanceTargetPositions.xy, 0.0));\nfloat angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);\nvec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);\nvec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);\nvec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);\nif (abs(currPos.x - prevPos.x) > 180.0) {\nindexDir = -1.0;\nisValid = 0.0;\n} else if (abs(currPos.x - nextPos.x) > 180.0) {\nindexDir = 1.0;\nisValid = 0.0;\n}\nnextPos = indexDir < 0.0 ? prevPos : nextPos;\nnextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;\nif (isValid == 0.0) {\nnextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;\nfloat t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);\ncurrPos = mix(currPos, nextPos, t);\nsegmentRatio = mix(segmentRatio, nextSegmentRatio, t);\n}\nvec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);\nvec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);\ncurr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);\nnext = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));\n} else {\nvec3 source_world = instanceSourcePositions;\nvec3 target_world = instanceTargetPositions;\nif (useShortestPath) {\nsource_world.x = mod(source_world.x + 180., 360.0) - 180.;\ntarget_world.x = mod(target_world.x + 180., 360.0) - 180.;\nfloat deltaLng = target_world.x - source_world.x;\nif (deltaLng > 180.) target_world.x -= 360.;\nif (deltaLng < -180.) source_world.x -= 360.;\n}\nsource = project_position(source_world, instanceSourcePositions64Low);\ntarget = project_position(target_world, instanceTargetPositions64Low);\nfloat antiMeridianX = 0.0;\nif (useShortestPath) {\nif (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\nantiMeridianX = -(project_uCoordinateOrigin.x + 180.) / 360. * TILE_SIZE;\n}\nfloat thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);\nif (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {\nisValid = 0.0;\nindexDir = sign(segmentRatio - thresholdRatio);\nsegmentRatio = thresholdRatio;\n}\n}\nnextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;\nvec3 currPos = interpolateFlat(source, target, segmentRatio);\nvec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);\nif (useShortestPath) {\nif (nextPos.x < antiMeridianX) {\ncurrPos.x += TILE_SIZE;\nnextPos.x += TILE_SIZE;\n}\n}\ncurr = project_common_position_to_clipspace(vec4(currPos, 1.0));\nnext = project_common_position_to_clipspace(vec4(nextPos, 1.0));\ngeometry.position = vec4(currPos, 1.0);\n}\nfloat widthPixels = clamp(\nproject_size_to_pixel(instanceWidths * widthScale, widthUnits),\nwidthMinPixels, widthMaxPixels\n);\nvec3 offset = vec3(\ngetExtrusionOffset((next.xy - curr.xy) * indexDir, positions.y, widthPixels),\n0.0);\nDECKGL_FILTER_SIZE(offset, geometry);\nDECKGL_FILTER_GL_POSITION(curr, geometry);\ngl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);\nvec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);\nvColor = vec4(color.rgb, color.a * opacity);\nDECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME arc-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nin vec2 uv;\nin float isValid;\nout vec4 fragColor;\nvoid main(void) {\nif (isValid == 0.0) {\ndiscard;\n}\nfragColor = vColor;\ngeometry.uv = uv;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[i.Z,r.Z]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getSourceColor",defaultValue:u},instanceTargetColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getTargetColor",defaultValue:u},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(t){super.updateState(t);const{props:e,oldProps:s,changeFlags:n}=t;var i;(n.extensionsChanged||e.numSegments!==s.numSegments)&&(null===(i=this.state.model)||void 0===i||i.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw(t){let{uniforms:e}=t;const{widthUnits:s,widthScale:n,widthMinPixels:i,widthMaxPixels:r,greatCircle:a,wrapLongitude:c}=this.props,u=this.state.model;u.setUniforms(e),u.setUniforms({greatCircle:a,widthUnits:o.iI[s],widthScale:n,widthMinPixels:i,widthMaxPixels:r,useShortestPath:c}),u.draw(this.context.renderPass)}_getModel(){const{numSegments:t}=this.props;let e=[];for(let n=0;n<t;n++)e=e.concat([n,1,0,n,-1,0]);const s=new c.H(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new a.Z({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0});return s.setUniforms({numSegments:t}),s}}h.layerName="ArcLayer",h.defaultProps=l},91362:(t,e,s)=>{s.d(e,{Z:()=>h});var n=s(51215),i=s(81333),r=s(58016),o=s(6955),a=s(99248),c=s(31910);const u=[0,0,0,255],l={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:t=>t.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:u},getLineColor:{type:"accessor",value:u},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class h extends n.Z{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME scatterplot-layer-vertex-shader\nin vec3 positions;\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin float instanceRadius;\nin float instanceLineWidths;\nin vec4 instanceFillColors;\nin vec4 instanceLineColors;\nin vec3 instancePickingColors;\nuniform float opacity;\nuniform float radiusScale;\nuniform float radiusMinPixels;\nuniform float radiusMaxPixels;\nuniform float lineWidthScale;\nuniform float lineWidthMinPixels;\nuniform float lineWidthMaxPixels;\nuniform float stroked;\nuniform bool filled;\nuniform bool antialiasing;\nuniform bool billboard;\nuniform int radiusUnits;\nuniform int lineWidthUnits;\nout vec4 vFillColor;\nout vec4 vLineColor;\nout vec2 unitPosition;\nout float innerUnitRadius;\nout float outerRadiusPixels;\nvoid main(void) {\ngeometry.worldPosition = instancePositions;\nouterRadiusPixels = clamp(\nproject_size_to_pixel(radiusScale * instanceRadius, radiusUnits),\nradiusMinPixels, radiusMaxPixels\n);\nfloat lineWidthPixels = clamp(\nproject_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),\nlineWidthMinPixels, lineWidthMaxPixels\n);\nouterRadiusPixels += stroked * lineWidthPixels / 2.0;\nfloat edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;\nunitPosition = edgePadding * positions.xy;\ngeometry.uv = unitPosition;\ngeometry.pickingColor = instancePickingColors;\ninnerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;\nif (billboard) {\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\nvec3 offset = edgePadding * positions * outerRadiusPixels;\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n} else {\nvec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n}\nvFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\nDECKGL_FILTER_COLOR(vFillColor, geometry);\nvLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\nDECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME scatterplot-layer-fragment-shader\nprecision highp float;\nuniform bool filled;\nuniform float stroked;\nuniform bool antialiasing;\nin vec4 vFillColor;\nin vec4 vLineColor;\nin vec2 unitPosition;\nin float innerUnitRadius;\nin float outerRadiusPixels;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = unitPosition;\nfloat distToCenter = length(unitPosition) * outerRadiusPixels;\nfloat inCircle = antialiasing ?\nsmoothedge(distToCenter, outerRadiusPixels) :\nstep(distToCenter, outerRadiusPixels);\nif (inCircle == 0.0) {\ndiscard;\n}\nif (stroked > 0.5) {\nfloat isLine = antialiasing ?\nsmoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :\nstep(innerUnitRadius * outerRadiusPixels, distToCenter);\nif (filled) {\nfragColor = mix(vFillColor, vLineColor, isLine);\n} else {\nif (isLine == 0.0) {\ndiscard;\n}\nfragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);\n}\n} else if (!filled) {\ndiscard;\n} else {\nfragColor = vFillColor;\n}\nfragColor.a *= inCircle;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[i.Z,r.Z]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){var e;(super.updateState(t),t.changeFlags.extensionsChanged)&&(null===(e=this.state.model)||void 0===e||e.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw(t){let{uniforms:e}=t;const{radiusUnits:s,radiusScale:n,radiusMinPixels:i,radiusMaxPixels:r,stroked:a,filled:c,billboard:u,antialiasing:l,lineWidthUnits:h,lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}=this.props,g=this.state.model;g.setUniforms(e),g.setUniforms({stroked:a?1:0,filled:c,billboard:u,antialiasing:l,radiusUnits:o.iI[s],radiusScale:n,radiusMinPixels:i,radiusMaxPixels:r,lineWidthUnits:o.iI[h],lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}),g.draw(this.context.renderPass)}_getModel(){return new c.H(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new a.Z({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0])}}}),isInstanced:!0})}}h.defaultProps=l,h.layerName="ScatterplotLayer"},72850:(t,e,s)=>{function n(t){const e=ArrayBuffer.isView(t)?t.constructor:t;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function i(t){switch(t){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(t)}}function r(t,e,s){if(!e||e>4)throw new Error("size ".concat(e));const i=e;let r=n(t);if("uint8"===r&&s&&1===i)return"unorm8-webgl";if("uint8"===r&&s&&3===i)return"unorm8x3-webgl";if("uint8"===r||"sint8"===r){if(1===i||3===i)throw new Error("size: ".concat(e));return s&&(r=r.replace("int","norm")),"".concat(r,"x").concat(i)}if("uint16"===r||"sint16"===r){if(1===i||3===i)throw new Error("size: ".concat(e));return s&&(r=r.replace("int","norm")),"".concat(r,"x").concat(i)}return 1===i?r:"".concat(r,"x").concat(i)}s.d(e,{C9:()=>n,Xs:()=>i,sk:()=>r})},99248:(t,e,s)=>{s.d(e,{Z:()=>o});var n=s(31916),i=s(92631),r=s(3540);class o{constructor(t){(0,n.Z)(this,"id",void 0),(0,n.Z)(this,"topology",void 0),(0,n.Z)(this,"vertexCount",void 0),(0,n.Z)(this,"indices",void 0),(0,n.Z)(this,"attributes",void 0),(0,n.Z)(this,"userData",{});const{attributes:e={},indices:s=null,vertexCount:o=null}=t;this.id=t.id||(0,i.h)("geometry"),this.topology=t.topology,s&&(this.indices=ArrayBuffer.isView(s)?{value:s,size:1}:s),this.attributes={};for(const[n,i]of Object.entries(e)){const t=ArrayBuffer.isView(i)?{value:i}:i;(0,r.h)(ArrayBuffer.isView(t.value),"".concat(this._print(n),": must be typed array or object with value as typed array")),"POSITION"!==n&&"positions"!==n||t.size||(t.size=3),"indices"===n?((0,r.h)(!this.indices),this.indices=t):this.attributes[n]=t}this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=o||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(t){return"Geometry ".concat(this.id," attribute ").concat(t)}_setAttributes(t,e){return this}_calculateVertexCount(t,e){if(e)return e.value.length;let s=1/0;for(const n of Object.values(t)){const{value:t,size:e,constant:i}=n;!i&&t&&e>=1&&(s=Math.min(s,t.length/e))}return(0,r.h)(Number.isFinite(s)),s}}},31910:(t,e,s)=>{s.d(e,{H:()=>he});var n=s(31916),i=s(13014),r=s(64092),o=s(92310),a=s(31502),c=s(64701);class u{constructor(t){if((0,n.Z)(this,"name",void 0),(0,n.Z)(this,"uniforms",{}),(0,n.Z)(this,"modifiedUniforms",{}),(0,n.Z)(this,"modified",!0),(0,n.Z)(this,"bindingLayout",{}),(0,n.Z)(this,"needsRedraw","initialized"),this.name=null===t||void 0===t?void 0:t.name,null!==t&&void 0!==t&&t.name&&null!==t&&void 0!==t&&t.shaderLayout){var e;const s=null===t||void 0===t||null===(e=t.shaderLayout.bindings)||void 0===e?void 0:e.find((e=>"uniform"===e.type&&e.name===(null===t||void 0===t?void 0:t.name)));if(!s)throw new Error(null===t||void 0===t?void 0:t.name);const n=s;for(const t of n.uniforms||[])this.bindingLayout[t.name]=t}}setUniforms(t){for(const[e,s]of Object.entries(t))this._setUniform(e,s),this.needsRedraw||this.setNeedsRedraw("".concat(this.name,".").concat(e,"=").concat(s))}setNeedsRedraw(t){this.needsRedraw=this.needsRedraw||t}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(t,e){(function(t,e){if(t!==e)return!1;const s=(0,c.v)(t);if(!s)return!1;const n=(0,c.v)(e);if(n&&s.length===n.length)for(let i=0;i<s.length;++i)if(n[i]!==s[i])return!1;return!0})(this.uniforms[t],e)||(this.uniforms[t]=function(t){const e=(0,c.v)(t);return e?e.slice():t}(e),this.modifiedUniforms[t]=!0,this.modified=!0)}}var l=s(3540);const h={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function d(t){const e=h[t];return(0,l.h)(t),e}function f(t,e){switch(e){case 1:return t;case 2:return t+t%2;default:return t+(4-t%4)%4}}var p=s(89600),g=s(78032);class _{constructor(t){(0,n.Z)(this,"layout",{}),(0,n.Z)(this,"byteLength",void 0);let e=0;for(const[n,i]of Object.entries(t)){const t=d(i),{type:s,components:r}=t;e=f(e,r);const o=e;e+=r,this.layout[n]={type:s,size:r,offset:o}}e+=(4-e%4)%4;const s=4*e;this.byteLength=Math.max(s,1024)}getData(t){const e=Math.max(this.byteLength,1024),s=(0,p.D4)(e),n={i32:new Int32Array(s),u32:new Uint32Array(s),f32:new Float32Array(s),f16:new Uint16Array(s)};for(const[i,r]of Object.entries(t)){const t=this.layout[i];if(!t){g.c.warn("Supplied uniform value ".concat(i," not present in uniform block layout"))();continue}const{type:e,size:s,offset:o}=t,a=n[e];if(1===s){if("number"!==typeof r&&"boolean"!==typeof r){g.c.warn("Supplied value for single component uniform ".concat(i," is not a number: ").concat(r))();continue}a[o]=Number(r)}else{const t=(0,c.v)(r);if(!t){g.c.warn("Supplied value for multi component / array uniform ".concat(i," is not a numeric array: ").concat(r))();continue}a.set(t,o)}}return new Uint8Array(s)}has(t){return Boolean(this.layout[t])}get(t){return this.layout[t]}}class m{constructor(t){(0,n.Z)(this,"uniformBlocks",new Map),(0,n.Z)(this,"uniformBufferLayouts",new Map),(0,n.Z)(this,"uniformBuffers",new Map);for(const[e,s]of Object.entries(t)){const t=e,n=new _(s.uniformTypes||{});this.uniformBufferLayouts.set(t,n);const i=new u({name:e});i.setUniforms(s.defaultUniforms||{}),this.uniformBlocks.set(t,i)}}destroy(){for(const t of this.uniformBuffers.values())t.destroy()}setUniforms(t){for(const[e,s]of Object.entries(t))this.uniformBlocks.get(e).setUniforms(s);this.updateUniformBuffers()}getUniformBufferByteLength(t){return this.uniformBufferLayouts.get(t).byteLength}getUniformBufferData(t){const e=this.uniformBlocks.get(t).getAllUniforms();return this.uniformBufferLayouts.get(t).getData(e)}createUniformBuffer(t,e,s){s&&this.setUniforms(s);const n=this.getUniformBufferByteLength(e),i=t.createBuffer({usage:r.l.UNIFORM|r.l.COPY_DST,byteLength:n}),o=this.getUniformBufferData(e);return i.write(o),i}getManagedUniformBuffer(t,e){if(!this.uniformBuffers.get(e)){const s=this.getUniformBufferByteLength(e),n=t.createBuffer({usage:r.l.UNIFORM|r.l.COPY_DST,byteLength:s});this.uniformBuffers.set(e,n)}return this.uniformBuffers.get(e)}updateUniformBuffers(){let t=!1;for(const e of this.uniformBlocks.keys()){const s=this.updateUniformBuffer(e);t||(t=s)}return t&&g.c.log(3,"UniformStore.updateUniformBuffers(): ".concat(t))(),t}updateUniformBuffer(t){const e=this.uniformBlocks.get(t);let s=!1;if(this.uniformBuffers.get(t)&&e.needsRedraw){s||(s=e.needsRedraw);const n=this.getUniformBufferData(t);this.uniformBuffers.get(t).write(n);const i=this.uniformBlocks.get(t).getAllUniforms();g.c.log(4,"Writing to uniform buffer ".concat(String(t)),n,i)()}return s}}var y=s(2200),v=s(92631);function b(t,e,s){if(t===e)return!0;if(!s||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!b(t[n],e[n],s-1))return!1;return!0}if(Array.isArray(e))return!1;if("object"===typeof t&&"object"===typeof e){const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!1;for(const r of n){if(!e.hasOwnProperty(r))return!1;if(!b(t[r],e[r],s-1))return!1}return!0}return!1}var w,x,k,A,T,P=s(35460),S=s(91586),C=s(72850);class E{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class I{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(t){throw new Error("Cannot evaluate node")}evaluateString(t){return this.evaluate(t).toString()}search(t){}searchBlock(t,e){if(t){e(L.instance);for(const s of t)s instanceof Array?this.searchBlock(s,e):s.search(e);e(O.instance)}}}class L extends I{}L.instance=new L;class O extends I{}O.instance=new O;class R extends I{constructor(){super()}}class N extends R{constructor(t,e,s,n,i,r){super(),this.calls=new Set,this.name=t,this.args=e,this.returnType=s,this.body=n,this.startLine=i,this.endLine=r}get astNodeType(){return"function"}search(t){this.searchBlock(this.body,t)}}class M extends R{constructor(t){super(),this.expression=t}get astNodeType(){return"staticAssert"}search(t){this.expression.search(t)}}class U extends R{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"while"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}}class F extends R{constructor(t){super(),this.body=t}get astNodeType(){return"continuing"}search(t){this.searchBlock(this.body,t)}}class B extends R{constructor(t,e,s,n){super(),this.init=t,this.condition=e,this.increment=s,this.body=n}get astNodeType(){return"for"}search(t){var e,s,n;null===(e=this.init)||void 0===e||e.search(t),null===(s=this.condition)||void 0===s||s.search(t),null===(n=this.increment)||void 0===n||n.search(t),this.searchBlock(this.body,t)}}class z extends R{constructor(t,e,s,n,i){super(),this.name=t,this.type=e,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"var"}search(t){var e;t(this),null===(e=this.value)||void 0===e||e.search(t)}}class j extends R{constructor(t,e,s){super(),this.name=t,this.type=e,this.value=s}get astNodeType(){return"override"}search(t){var e;null===(e=this.value)||void 0===e||e.search(t)}}class D extends R{constructor(t,e,s,n,i){super(),this.name=t,this.type=e,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"let"}search(t){var e;t(this),null===(e=this.value)||void 0===e||e.search(t)}}class Z extends R{constructor(t,e,s,n,i){super(),this.name=t,this.type=e,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"const"}evaluate(t){return this.value.evaluate(t)}search(t){var e;t(this),null===(e=this.value)||void 0===e||e.search(t)}}!function(t){t.increment="++",t.decrement="--"}(w||(w={})),function(t){t.parse=function(e){const s=e;if("parse"==s)throw new Error("Invalid value for IncrementOperator");return t[s]}}(w||(w={}));class V extends R{constructor(t,e){super(),this.operator=t,this.variable=e}get astNodeType(){return"increment"}search(t){this.variable.search(t)}}!function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="}(x||(x={})),function(t){t.parse=function(t){const e=t;if("parse"==e)throw new Error("Invalid value for AssignOperator");return e}}(x||(x={}));class q extends R{constructor(t,e,s){super(),this.operator=t,this.variable=e,this.value=s}get astNodeType(){return"assign"}search(t){this.variable.search(t),this.value.search(t)}}class W extends R{constructor(t,e){super(),this.name=t,this.args=e}get astNodeType(){return"call"}search(t){for(const e of this.args)e.search(t);t(this)}}class G extends R{constructor(t,e){super(),this.body=t,this.continuing=e}get astNodeType(){return"loop"}}class H extends R{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"body"}}class Y extends R{constructor(t,e,s,n){super(),this.condition=t,this.body=e,this.elseif=s,this.else=n}get astNodeType(){return"if"}search(t){this.condition.search(t),this.searchBlock(this.body,t),this.searchBlock(this.elseif,t),this.searchBlock(this.else,t)}}class K extends R{constructor(t){super(),this.value=t}get astNodeType(){return"return"}search(t){var e;null===(e=this.value)||void 0===e||e.search(t)}}class X extends R{constructor(t){super(),this.name=t}get astNodeType(){return"enable"}}class J extends R{constructor(t){super(),this.extensions=t}get astNodeType(){return"requires"}}class Q extends R{constructor(t,e){super(),this.severity=t,this.rule=e}get astNodeType(){return"diagnostic"}}class $ extends R{constructor(t,e){super(),this.name=t,this.type=e}get astNodeType(){return"alias"}}class tt extends R{constructor(){super()}get astNodeType(){return"discard"}}class et extends R{constructor(){super()}get astNodeType(){return"break"}}class st extends R{constructor(){super()}get astNodeType(){return"continue"}}class nt extends R{constructor(t){super(),this.name=t}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class it extends nt{constructor(t,e,s,n){super(t),this.members=e,this.startLine=s,this.endLine=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(t){for(let e=0;e<this.members.length;e++)if(this.members[e].name==t)return e;return-1}}class rt extends nt{constructor(t,e,s){super(t),this.format=e,this.access=s}get astNodeType(){return"template"}}class ot extends nt{constructor(t,e,s,n){super(t),this.storage=e,this.type=s,this.access=n}get astNodeType(){return"pointer"}}class at extends nt{constructor(t,e,s,n){super(t),this.attributes=e,this.format=s,this.count=n}get astNodeType(){return"array"}get isArray(){return!0}}class ct extends nt{constructor(t,e,s){super(t),this.format=e,this.access=s}get astNodeType(){return"sampler"}}class ut extends I{constructor(){super()}}class lt extends ut{constructor(t){super(),this.value=t}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class ht extends ut{constructor(t,e){super(),this.type=t,this.args=e}get astNodeType(){return"createExpr"}search(t){t(this);for(const e of this.args)e.search(t)}}class dt extends ut{constructor(t,e){super(),this.name=t,this.args=e}get astNodeType(){return"callExpr"}evaluate(t){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(t));case"acos":return Math.acos(this.args[0].evaluate(t));case"acosh":return Math.acosh(this.args[0].evaluate(t));case"asin":return Math.asin(this.args[0].evaluate(t));case"asinh":return Math.asinh(this.args[0].evaluate(t));case"atan":return Math.atan(this.args[0].evaluate(t));case"atan2":return Math.atan2(this.args[0].evaluate(t),this.args[1].evaluate(t));case"atanh":return Math.atanh(this.args[0].evaluate(t));case"ceil":return Math.ceil(this.args[0].evaluate(t));case"clamp":return Math.min(Math.max(this.args[0].evaluate(t),this.args[1].evaluate(t)),this.args[2].evaluate(t));case"cos":return Math.cos(this.args[0].evaluate(t));case"degrees":return 180*this.args[0].evaluate(t)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(t)-this.args[1].evaluate(t),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(t));case"exp2":return Math.pow(2,this.args[0].evaluate(t));case"floor":return Math.floor(this.args[0].evaluate(t));case"fma":return this.args[0].evaluate(t)*this.args[1].evaluate(t)+this.args[2].evaluate(t);case"fract":case"modf":return this.args[0].evaluate(t)-Math.floor(this.args[0].evaluate(t));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(t));case"log":return Math.log(this.args[0].evaluate(t));case"log2":return Math.log2(this.args[0].evaluate(t));case"max":return Math.max(this.args[0].evaluate(t),this.args[1].evaluate(t));case"min":return Math.min(this.args[0].evaluate(t),this.args[1].evaluate(t));case"mix":return this.args[0].evaluate(t)*(1-this.args[2].evaluate(t))+this.args[1].evaluate(t)*this.args[2].evaluate(t);case"pow":return Math.pow(this.args[0].evaluate(t),this.args[1].evaluate(t));case"radians":return this.args[0].evaluate(t)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(t));case"sign":return Math.sign(this.args[0].evaluate(t));case"sin":return Math.sin(this.args[0].evaluate(t));case"sinh":return Math.sinh(this.args[0].evaluate(t));case"saturate":return Math.min(Math.max(this.args[0].evaluate(t),0),1);case"smoothstep":return this.args[0].evaluate(t)*this.args[0].evaluate(t)*(3-2*this.args[0].evaluate(t));case"sqrt":return Math.sqrt(this.args[0].evaluate(t));case"step":return this.args[0].evaluate(t)<this.args[1].evaluate(t)?0:1;case"tan":return Math.tan(this.args[0].evaluate(t));case"tanh":return Math.tanh(this.args[0].evaluate(t));case"trunc":return Math.trunc(this.args[0].evaluate(t));default:throw new Error("Non const function: "+this.name)}}search(t){for(const e of this.args)e.search(t);t(this)}}class ft extends ut{constructor(t){super(),this.name=t}get astNodeType(){return"varExpr"}search(t){t(this),this.postfix&&this.postfix.search(t)}evaluate(t){const e=t.constants.get(this.name);if(!e)throw new Error("Cannot evaluate node");return e.evaluate(t)}}class pt extends ut{constructor(t,e){super(),this.name=t,this.initializer=e}get astNodeType(){return"constExpr"}evaluate(t){var e,s;if(this.initializer instanceof ht){const n=null===(e=this.postfix)||void 0===e?void 0:e.evaluateString(t),i=null===(s=this.initializer.type)||void 0===s?void 0:s.name,r=t.structs.get(i),o=null===r||void 0===r?void 0:r.getMemberIndex(n);if(-1!=o){return this.initializer.args[o].evaluate(t)}console.log(o)}return this.initializer.evaluate(t)}search(t){this.initializer.search(t)}}class gt extends ut{constructor(t){super(),this.value=t}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class _t extends ut{constructor(t,e){super(),this.type=t,this.value=e}get astNodeType(){return"bitcastExpr"}search(t){this.value.search(t)}}class mt extends ut{constructor(t,e){super(),this.type=t,this.args=e}get astNodeType(){return"typecastExpr"}evaluate(t){return this.args[0].evaluate(t)}search(t){this.searchBlock(this.args,t)}}class yt extends ut{constructor(t){super(),this.contents=t}get astNodeType(){return"groupExpr"}evaluate(t){return this.contents[0].evaluate(t)}search(t){this.searchBlock(this.contents,t)}}class vt extends ut{constructor(t){super(),this.index=t}search(t){this.index.search(t)}}class bt extends ut{constructor(){super()}}class wt extends bt{constructor(t,e){super(),this.operator=t,this.right=e}get astNodeType(){return"unaryOp"}evaluate(t){switch(this.operator){case"+":return this.right.evaluate(t);case"-":return-this.right.evaluate(t);case"!":return this.right.evaluate(t)?0:1;case"~":return~this.right.evaluate(t);default:throw new Error("Unknown unary operator: "+this.operator)}}search(t){this.right.search(t)}}class xt extends bt{constructor(t,e,s){super(),this.operator=t,this.left=e,this.right=s}get astNodeType(){return"binaryOp"}evaluate(t){switch(this.operator){case"+":return this.left.evaluate(t)+this.right.evaluate(t);case"-":return this.left.evaluate(t)-this.right.evaluate(t);case"*":return this.left.evaluate(t)*this.right.evaluate(t);case"/":return this.left.evaluate(t)/this.right.evaluate(t);case"%":return this.left.evaluate(t)%this.right.evaluate(t);case"==":return this.left.evaluate(t)==this.right.evaluate(t)?1:0;case"!=":return this.left.evaluate(t)!=this.right.evaluate(t)?1:0;case"<":return this.left.evaluate(t)<this.right.evaluate(t)?1:0;case">":return this.left.evaluate(t)>this.right.evaluate(t)?1:0;case"<=":return this.left.evaluate(t)<=this.right.evaluate(t)?1:0;case">=":return this.left.evaluate(t)>=this.right.evaluate(t)?1:0;case"&&":return this.left.evaluate(t)&&this.right.evaluate(t)?1:0;case"||":return this.left.evaluate(t)||this.right.evaluate(t)?1:0;default:throw new Error("Unknown operator ".concat(this.operator))}}search(t){this.left.search(t),this.right.search(t)}}class kt extends I{constructor(){super()}}class At extends kt{constructor(t,e){super(),this.selector=t,this.body=e}get astNodeType(){return"case"}search(t){this.searchBlock(this.body,t)}}class Tt extends kt{constructor(t){super(),this.body=t}get astNodeType(){return"default"}search(t){this.searchBlock(this.body,t)}}class Pt extends I{constructor(t,e,s){super(),this.name=t,this.type=e,this.attributes=s}get astNodeType(){return"argument"}}class St extends I{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"elseif"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}}class Ct extends I{constructor(t,e,s){super(),this.name=t,this.type=e,this.attributes=s}get astNodeType(){return"member"}}class Et extends I{constructor(t,e){super(),this.name=t,this.value=e}get astNodeType(){return"attribute"}}!function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"}(A||(A={}));class It{constructor(t,e,s){this.name=t,this.type=e,this.rule=s}toString(){return this.name}}class Lt{}k=Lt,Lt.none=new It("",A.reserved,""),Lt.eof=new It("EOF",A.token,""),Lt.reserved={asm:new It("asm",A.reserved,"asm"),bf16:new It("bf16",A.reserved,"bf16"),do:new It("do",A.reserved,"do"),enum:new It("enum",A.reserved,"enum"),f16:new It("f16",A.reserved,"f16"),f64:new It("f64",A.reserved,"f64"),handle:new It("handle",A.reserved,"handle"),i8:new It("i8",A.reserved,"i8"),i16:new It("i16",A.reserved,"i16"),i64:new It("i64",A.reserved,"i64"),mat:new It("mat",A.reserved,"mat"),premerge:new It("premerge",A.reserved,"premerge"),regardless:new It("regardless",A.reserved,"regardless"),typedef:new It("typedef",A.reserved,"typedef"),u8:new It("u8",A.reserved,"u8"),u16:new It("u16",A.reserved,"u16"),u64:new It("u64",A.reserved,"u64"),unless:new It("unless",A.reserved,"unless"),using:new It("using",A.reserved,"using"),vec:new It("vec",A.reserved,"vec"),void:new It("void",A.reserved,"void")},Lt.keywords={array:new It("array",A.keyword,"array"),atomic:new It("atomic",A.keyword,"atomic"),bool:new It("bool",A.keyword,"bool"),f32:new It("f32",A.keyword,"f32"),i32:new It("i32",A.keyword,"i32"),mat2x2:new It("mat2x2",A.keyword,"mat2x2"),mat2x3:new It("mat2x3",A.keyword,"mat2x3"),mat2x4:new It("mat2x4",A.keyword,"mat2x4"),mat3x2:new It("mat3x2",A.keyword,"mat3x2"),mat3x3:new It("mat3x3",A.keyword,"mat3x3"),mat3x4:new It("mat3x4",A.keyword,"mat3x4"),mat4x2:new It("mat4x2",A.keyword,"mat4x2"),mat4x3:new It("mat4x3",A.keyword,"mat4x3"),mat4x4:new It("mat4x4",A.keyword,"mat4x4"),ptr:new It("ptr",A.keyword,"ptr"),sampler:new It("sampler",A.keyword,"sampler"),sampler_comparison:new It("sampler_comparison",A.keyword,"sampler_comparison"),struct:new It("struct",A.keyword,"struct"),texture_1d:new It("texture_1d",A.keyword,"texture_1d"),texture_2d:new It("texture_2d",A.keyword,"texture_2d"),texture_2d_array:new It("texture_2d_array",A.keyword,"texture_2d_array"),texture_3d:new It("texture_3d",A.keyword,"texture_3d"),texture_cube:new It("texture_cube",A.keyword,"texture_cube"),texture_cube_array:new It("texture_cube_array",A.keyword,"texture_cube_array"),texture_multisampled_2d:new It("texture_multisampled_2d",A.keyword,"texture_multisampled_2d"),texture_storage_1d:new It("texture_storage_1d",A.keyword,"texture_storage_1d"),texture_storage_2d:new It("texture_storage_2d",A.keyword,"texture_storage_2d"),texture_storage_2d_array:new It("texture_storage_2d_array",A.keyword,"texture_storage_2d_array"),texture_storage_3d:new It("texture_storage_3d",A.keyword,"texture_storage_3d"),texture_depth_2d:new It("texture_depth_2d",A.keyword,"texture_depth_2d"),texture_depth_2d_array:new It("texture_depth_2d_array",A.keyword,"texture_depth_2d_array"),texture_depth_cube:new It("texture_depth_cube",A.keyword,"texture_depth_cube"),texture_depth_cube_array:new It("texture_depth_cube_array",A.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new It("texture_depth_multisampled_2d",A.keyword,"texture_depth_multisampled_2d"),texture_external:new It("texture_external",A.keyword,"texture_external"),u32:new It("u32",A.keyword,"u32"),vec2:new It("vec2",A.keyword,"vec2"),vec3:new It("vec3",A.keyword,"vec3"),vec4:new It("vec4",A.keyword,"vec4"),bitcast:new It("bitcast",A.keyword,"bitcast"),block:new It("block",A.keyword,"block"),break:new It("break",A.keyword,"break"),case:new It("case",A.keyword,"case"),continue:new It("continue",A.keyword,"continue"),continuing:new It("continuing",A.keyword,"continuing"),default:new It("default",A.keyword,"default"),diagnostic:new It("diagnostic",A.keyword,"diagnostic"),discard:new It("discard",A.keyword,"discard"),else:new It("else",A.keyword,"else"),enable:new It("enable",A.keyword,"enable"),fallthrough:new It("fallthrough",A.keyword,"fallthrough"),false:new It("false",A.keyword,"false"),fn:new It("fn",A.keyword,"fn"),for:new It("for",A.keyword,"for"),function:new It("function",A.keyword,"function"),if:new It("if",A.keyword,"if"),let:new It("let",A.keyword,"let"),const:new It("const",A.keyword,"const"),loop:new It("loop",A.keyword,"loop"),while:new It("while",A.keyword,"while"),private:new It("private",A.keyword,"private"),read:new It("read",A.keyword,"read"),read_write:new It("read_write",A.keyword,"read_write"),return:new It("return",A.keyword,"return"),requires:new It("requires",A.keyword,"requires"),storage:new It("storage",A.keyword,"storage"),switch:new It("switch",A.keyword,"switch"),true:new It("true",A.keyword,"true"),alias:new It("alias",A.keyword,"alias"),type:new It("type",A.keyword,"type"),uniform:new It("uniform",A.keyword,"uniform"),var:new It("var",A.keyword,"var"),override:new It("override",A.keyword,"override"),workgroup:new It("workgroup",A.keyword,"workgroup"),write:new It("write",A.keyword,"write"),r8unorm:new It("r8unorm",A.keyword,"r8unorm"),r8snorm:new It("r8snorm",A.keyword,"r8snorm"),r8uint:new It("r8uint",A.keyword,"r8uint"),r8sint:new It("r8sint",A.keyword,"r8sint"),r16uint:new It("r16uint",A.keyword,"r16uint"),r16sint:new It("r16sint",A.keyword,"r16sint"),r16float:new It("r16float",A.keyword,"r16float"),rg8unorm:new It("rg8unorm",A.keyword,"rg8unorm"),rg8snorm:new It("rg8snorm",A.keyword,"rg8snorm"),rg8uint:new It("rg8uint",A.keyword,"rg8uint"),rg8sint:new It("rg8sint",A.keyword,"rg8sint"),r32uint:new It("r32uint",A.keyword,"r32uint"),r32sint:new It("r32sint",A.keyword,"r32sint"),r32float:new It("r32float",A.keyword,"r32float"),rg16uint:new It("rg16uint",A.keyword,"rg16uint"),rg16sint:new It("rg16sint",A.keyword,"rg16sint"),rg16float:new It("rg16float",A.keyword,"rg16float"),rgba8unorm:new It("rgba8unorm",A.keyword,"rgba8unorm"),rgba8unorm_srgb:new It("rgba8unorm_srgb",A.keyword,"rgba8unorm_srgb"),rgba8snorm:new It("rgba8snorm",A.keyword,"rgba8snorm"),rgba8uint:new It("rgba8uint",A.keyword,"rgba8uint"),rgba8sint:new It("rgba8sint",A.keyword,"rgba8sint"),bgra8unorm:new It("bgra8unorm",A.keyword,"bgra8unorm"),bgra8unorm_srgb:new It("bgra8unorm_srgb",A.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new It("rgb10a2unorm",A.keyword,"rgb10a2unorm"),rg11b10float:new It("rg11b10float",A.keyword,"rg11b10float"),rg32uint:new It("rg32uint",A.keyword,"rg32uint"),rg32sint:new It("rg32sint",A.keyword,"rg32sint"),rg32float:new It("rg32float",A.keyword,"rg32float"),rgba16uint:new It("rgba16uint",A.keyword,"rgba16uint"),rgba16sint:new It("rgba16sint",A.keyword,"rgba16sint"),rgba16float:new It("rgba16float",A.keyword,"rgba16float"),rgba32uint:new It("rgba32uint",A.keyword,"rgba32uint"),rgba32sint:new It("rgba32sint",A.keyword,"rgba32sint"),rgba32float:new It("rgba32float",A.keyword,"rgba32float"),static_assert:new It("static_assert",A.keyword,"static_assert")},Lt.tokens={decimal_float_literal:new It("decimal_float_literal",A.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new It("hex_float_literal",A.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new It("int_literal",A.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new It("uint_literal",A.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new It("ident",A.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new It("and",A.token,"&"),and_and:new It("and_and",A.token,"&&"),arrow:new It("arrow ",A.token,"->"),attr:new It("attr",A.token,"@"),forward_slash:new It("forward_slash",A.token,"/"),bang:new It("bang",A.token,"!"),bracket_left:new It("bracket_left",A.token,"["),bracket_right:new It("bracket_right",A.token,"]"),brace_left:new It("brace_left",A.token,"{"),brace_right:new It("brace_right",A.token,"}"),colon:new It("colon",A.token,":"),comma:new It("comma",A.token,","),equal:new It("equal",A.token,"="),equal_equal:new It("equal_equal",A.token,"=="),not_equal:new It("not_equal",A.token,"!="),greater_than:new It("greater_than",A.token,">"),greater_than_equal:new It("greater_than_equal",A.token,">="),shift_right:new It("shift_right",A.token,">>"),less_than:new It("less_than",A.token,"<"),less_than_equal:new It("less_than_equal",A.token,"<="),shift_left:new It("shift_left",A.token,"<<"),modulo:new It("modulo",A.token,"%"),minus:new It("minus",A.token,"-"),minus_minus:new It("minus_minus",A.token,"--"),period:new It("period",A.token,"."),plus:new It("plus",A.token,"+"),plus_plus:new It("plus_plus",A.token,"++"),or:new It("or",A.token,"|"),or_or:new It("or_or",A.token,"||"),paren_left:new It("paren_left",A.token,"("),paren_right:new It("paren_right",A.token,")"),semicolon:new It("semicolon",A.token,";"),star:new It("star",A.token,"*"),tilde:new It("tilde",A.token,"~"),underscore:new It("underscore",A.token,"_"),xor:new It("xor",A.token,"^"),plus_equal:new It("plus_equal",A.token,"+="),minus_equal:new It("minus_equal",A.token,"-="),times_equal:new It("times_equal",A.token,"*="),division_equal:new It("division_equal",A.token,"/="),modulo_equal:new It("modulo_equal",A.token,"%="),and_equal:new It("and_equal",A.token,"&="),or_equal:new It("or_equal",A.token,"|="),xor_equal:new It("xor_equal",A.token,"^="),shift_right_equal:new It("shift_right_equal",A.token,">>="),shift_left_equal:new It("shift_left_equal",A.token,"<<=")},Lt.simpleTokens={"@":k.tokens.attr,"{":k.tokens.brace_left,"}":k.tokens.brace_right,":":k.tokens.colon,",":k.tokens.comma,"(":k.tokens.paren_left,")":k.tokens.paren_right,";":k.tokens.semicolon},Lt.literalTokens={"&":k.tokens.and,"&&":k.tokens.and_and,"->":k.tokens.arrow,"/":k.tokens.forward_slash,"!":k.tokens.bang,"[":k.tokens.bracket_left,"]":k.tokens.bracket_right,"=":k.tokens.equal,"==":k.tokens.equal_equal,"!=":k.tokens.not_equal,">":k.tokens.greater_than,">=":k.tokens.greater_than_equal,">>":k.tokens.shift_right,"<":k.tokens.less_than,"<=":k.tokens.less_than_equal,"<<":k.tokens.shift_left,"%":k.tokens.modulo,"-":k.tokens.minus,"--":k.tokens.minus_minus,".":k.tokens.period,"+":k.tokens.plus,"++":k.tokens.plus_plus,"|":k.tokens.or,"||":k.tokens.or_or,"*":k.tokens.star,"~":k.tokens.tilde,_:k.tokens.underscore,"^":k.tokens.xor,"+=":k.tokens.plus_equal,"-=":k.tokens.minus_equal,"*=":k.tokens.times_equal,"/=":k.tokens.division_equal,"%=":k.tokens.modulo_equal,"&=":k.tokens.and_equal,"|=":k.tokens.or_equal,"^=":k.tokens.xor_equal,">>=":k.tokens.shift_right_equal,"<<=":k.tokens.shift_left_equal},Lt.regexTokens={decimal_float_literal:k.tokens.decimal_float_literal,hex_float_literal:k.tokens.hex_float_literal,int_literal:k.tokens.int_literal,uint_literal:k.tokens.uint_literal,ident:k.tokens.ident},Lt.storage_class=[k.keywords.function,k.keywords.private,k.keywords.workgroup,k.keywords.uniform,k.keywords.storage],Lt.access_mode=[k.keywords.read,k.keywords.write,k.keywords.read_write],Lt.sampler_type=[k.keywords.sampler,k.keywords.sampler_comparison],Lt.sampled_texture_type=[k.keywords.texture_1d,k.keywords.texture_2d,k.keywords.texture_2d_array,k.keywords.texture_3d,k.keywords.texture_cube,k.keywords.texture_cube_array],Lt.multisampled_texture_type=[k.keywords.texture_multisampled_2d],Lt.storage_texture_type=[k.keywords.texture_storage_1d,k.keywords.texture_storage_2d,k.keywords.texture_storage_2d_array,k.keywords.texture_storage_3d],Lt.depth_texture_type=[k.keywords.texture_depth_2d,k.keywords.texture_depth_2d_array,k.keywords.texture_depth_cube,k.keywords.texture_depth_cube_array,k.keywords.texture_depth_multisampled_2d],Lt.texture_external_type=[k.keywords.texture_external],Lt.any_texture_type=[...k.sampled_texture_type,...k.multisampled_texture_type,...k.storage_texture_type,...k.depth_texture_type,...k.texture_external_type],Lt.texel_format=[k.keywords.r8unorm,k.keywords.r8snorm,k.keywords.r8uint,k.keywords.r8sint,k.keywords.r16uint,k.keywords.r16sint,k.keywords.r16float,k.keywords.rg8unorm,k.keywords.rg8snorm,k.keywords.rg8uint,k.keywords.rg8sint,k.keywords.r32uint,k.keywords.r32sint,k.keywords.r32float,k.keywords.rg16uint,k.keywords.rg16sint,k.keywords.rg16float,k.keywords.rgba8unorm,k.keywords.rgba8unorm_srgb,k.keywords.rgba8snorm,k.keywords.rgba8uint,k.keywords.rgba8sint,k.keywords.bgra8unorm,k.keywords.bgra8unorm_srgb,k.keywords.rgb10a2unorm,k.keywords.rg11b10float,k.keywords.rg32uint,k.keywords.rg32sint,k.keywords.rg32float,k.keywords.rgba16uint,k.keywords.rgba16sint,k.keywords.rgba16float,k.keywords.rgba32uint,k.keywords.rgba32sint,k.keywords.rgba32float],Lt.const_literal=[k.tokens.int_literal,k.tokens.uint_literal,k.tokens.decimal_float_literal,k.tokens.hex_float_literal,k.keywords.true,k.keywords.false],Lt.literal_or_ident=[k.tokens.ident,k.tokens.int_literal,k.tokens.uint_literal,k.tokens.decimal_float_literal,k.tokens.hex_float_literal],Lt.element_count_expression=[k.tokens.int_literal,k.tokens.uint_literal,k.tokens.ident],Lt.template_types=[k.keywords.vec2,k.keywords.vec3,k.keywords.vec4,k.keywords.mat2x2,k.keywords.mat2x3,k.keywords.mat2x4,k.keywords.mat3x2,k.keywords.mat3x3,k.keywords.mat3x4,k.keywords.mat4x2,k.keywords.mat4x3,k.keywords.mat4x4,k.keywords.atomic,k.keywords.bitcast,...k.any_texture_type],Lt.attribute_name=[k.tokens.ident,k.keywords.block,k.keywords.diagnostic],Lt.assignment_operators=[k.tokens.equal,k.tokens.plus_equal,k.tokens.minus_equal,k.tokens.times_equal,k.tokens.division_equal,k.tokens.modulo_equal,k.tokens.and_equal,k.tokens.or_equal,k.tokens.xor_equal,k.tokens.shift_right_equal,k.tokens.shift_left_equal],Lt.increment_operators=[k.tokens.plus_plus,k.tokens.minus_minus];class Ot{constructor(t,e,s){this.type=t,this.lexeme=e,this.line=s}toString(){return this.lexeme}isTemplateType(){return-1!=Lt.template_types.indexOf(this.type)}isArrayType(){return this.type==Lt.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class Rt{constructor(t){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!==t&&void 0!==t?t:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw"Invalid syntax at line ".concat(this._line);return this._tokens.push(new Ot(Lt.eof,"",this._line)),this._tokens}scanToken(){let t=this._advance();if("\n"==t)return this._line++,!0;if(this._isWhitespace(t))return!0;if("/"==t){if("/"==this._peekAhead()){for(;"\n"!=t;){if(this._isAtEnd())return!0;t=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let e=1;for(;e>0;){if(this._isAtEnd())return!0;if(t=this._advance(),"\n"==t)this._line++;else if("*"==t){if("/"==this._peekAhead()&&(this._advance(),e--,0==e))return!0}else"/"==t&&"*"==this._peekAhead()&&(this._advance(),e++)}return!0}}const e=Lt.simpleTokens[t];if(e)return this._addToken(e),!0;let s=Lt.none;const n=this._isAlpha(t),i="_"===t;if(this._isAlphaNumeric(t)){let e=this._peekAhead();for(;this._isAlphaNumeric(e);)t+=this._advance(),e=this._peekAhead()}if(n){const e=Lt.keywords[t];if(e)return this._addToken(e),!0}if(n||i)return this._addToken(Lt.tokens.ident),!0;for(;;){let e=this._findType(t);const n=this._peekAhead();if("-"==t&&this._tokens.length>0){if("="==n)return this._current++,t+=n,this._addToken(Lt.tokens.minus_equal),!0;if("-"==n)return this._current++,t+=n,this._addToken(Lt.tokens.minus_minus),!0;const s=this._tokens.length-1;if((-1!=Lt.literal_or_ident.indexOf(this._tokens[s].type)||this._tokens[s].type==Lt.tokens.paren_right)&&">"!=n)return this._addToken(e),!0}if(">"==t&&(">"==n||"="==n)){let t=!1,s=this._tokens.length-1;for(let e=0;e<5&&s>=0&&-1===Lt.assignment_operators.indexOf(this._tokens[s].type);++e,--s)if(this._tokens[s].type===Lt.tokens.less_than){s>0&&this._tokens[s-1].isArrayOrTemplateType()&&(t=!0);break}if(t)return this._addToken(e),!0}if(e===Lt.none){let n=t,i=0;const r=2;for(let t=0;t<r;++t)if(n+=this._peekAhead(t),e=this._findType(n),e!==Lt.none){i=t;break}if(e===Lt.none)return s!==Lt.none&&(this._current--,this._addToken(s),!0);t=n,this._current+=i+1}if(s=e,this._isAtEnd())break;t+=this._advance()}return s!==Lt.none&&(this._addToken(s),!0)}_findType(t){for(const s in Lt.regexTokens){const e=Lt.regexTokens[s];if(this._match(t,e.rule))return e}const e=Lt.literalTokens[t];return e||Lt.none}_match(t,e){const s=e.exec(t);return s&&0==s.index&&s[0]==t}_isAtEnd(){return this._current>=this._source.length}_isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}_isAlphaNumeric(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||"_"==t||t>="0"&&t<="9"}_isWhitespace(t){return" "==t||"\t"==t||"\r"==t}_advance(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this._source[this._current];return t=t||0,t++,this._current+=t,e}_peekAhead(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return t=t||0,this._current+t>=this._source.length?"\0":this._source[this._current+t]}_addToken(t){const e=this._source.substring(this._start,this._current);this._tokens.push(new Ot(t,e,this._line))}}class Nt{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new E,this._deferArrayCountEval=[]}parse(t){this._initialize(t),this._deferArrayCountEval.length=0;const e=[];for(;!this._isAtEnd();){const t=this._global_decl_or_directive();if(!t)break;e.push(t)}if(this._deferArrayCountEval.length>0){for(const t of this._deferArrayCountEval){const e=t.arrayType,n=t.countNode;if(n instanceof ft){const t=n.name,i=this._context.constants.get(t);if(i)try{const t=i.evaluate(this._context);e.count=t}catch(s){}}}this._deferArrayCountEval.length=0}return e}_initialize(t){if(t)if("string"==typeof t){const e=new Rt(t);this._tokens=e.scanTokens()}else this._tokens=t;else this._tokens=[];this._current=0}_error(t,e){return{token:t,message:e,toString:function(){return"".concat(e)}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==Lt.eof}_match(t){if(t instanceof It)return!!this._check(t)&&(this._advance(),!0);for(let e=0,s=t.length;e<s;++e){const s=t[e];if(this._check(s))return this._advance(),!0}return!1}_consume(t,e){if(this._check(t))return this._advance();throw this._error(this._peek(),e)}_check(t){if(this._isAtEnd())return!1;const e=this._peek();if(t instanceof Array){const s=e.type;return-1!=t.indexOf(s)}return e.type==t}_advance(){var t,e;return this._currentLine=null!==(e=null===(t=this._peek())||void 0===t?void 0:t.line)&&void 0!==e?e:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(Lt.tokens.semicolon)&&!this._isAtEnd(););if(this._match(Lt.keywords.alias)){const t=this._type_alias();return this._consume(Lt.tokens.semicolon,"Expected ';'"),t}if(this._match(Lt.keywords.diagnostic)){const t=this._diagnostic();return this._consume(Lt.tokens.semicolon,"Expected ';'"),t}if(this._match(Lt.keywords.requires)){const t=this._requires_directive();return this._consume(Lt.tokens.semicolon,"Expected ';'"),t}if(this._match(Lt.keywords.enable)){const t=this._enable_directive();return this._consume(Lt.tokens.semicolon,"Expected ';'"),t}const t=this._attribute();if(this._check(Lt.keywords.var)){const e=this._global_variable_decl();return null!=e&&(e.attributes=t),this._consume(Lt.tokens.semicolon,"Expected ';'."),e}if(this._check(Lt.keywords.override)){const e=this._override_variable_decl();return null!=e&&(e.attributes=t),this._consume(Lt.tokens.semicolon,"Expected ';'."),e}if(this._check(Lt.keywords.let)){const e=this._global_let_decl();return null!=e&&(e.attributes=t),this._consume(Lt.tokens.semicolon,"Expected ';'."),e}if(this._check(Lt.keywords.const)){const e=this._global_const_decl();return null!=e&&(e.attributes=t),this._consume(Lt.tokens.semicolon,"Expected ';'."),e}if(this._check(Lt.keywords.struct)){const e=this._struct_decl();return null!=e&&(e.attributes=t),e}if(this._check(Lt.keywords.fn)){const e=this._function_decl();return null!=e&&(e.attributes=t),e}return null}_function_decl(){if(!this._match(Lt.keywords.fn))return null;const t=this._currentLine,e=this._consume(Lt.tokens.ident,"Expected function name.").toString();this._consume(Lt.tokens.paren_left,"Expected '(' for function arguments.");const s=[];if(!this._check(Lt.tokens.paren_right))do{if(this._check(Lt.tokens.paren_right))break;const t=this._attribute(),e=this._consume(Lt.tokens.ident,"Expected argument name.").toString();this._consume(Lt.tokens.colon,"Expected ':' for argument type.");const n=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=n,s.push(new Pt(e,i,t)))}while(this._match(Lt.tokens.comma));this._consume(Lt.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(Lt.tokens.arrow)){const t=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=t)}const i=this._compound_statement(),r=this._currentLine;return new N(e,s,n,i,t,r)}_compound_statement(){const t=[];for(this._consume(Lt.tokens.brace_left,"Expected '{' for block.");!this._check(Lt.tokens.brace_right);){const e=this._statement();null!==e&&t.push(e)}return this._consume(Lt.tokens.brace_right,"Expected '}' for block."),t}_statement(){for(;this._match(Lt.tokens.semicolon)&&!this._isAtEnd(););if(this._check(Lt.tokens.attr)&&this._attribute(),this._check(Lt.keywords.if))return this._if_statement();if(this._check(Lt.keywords.switch))return this._switch_statement();if(this._check(Lt.keywords.loop))return this._loop_statement();if(this._check(Lt.keywords.for))return this._for_statement();if(this._check(Lt.keywords.while))return this._while_statement();if(this._check(Lt.keywords.continuing))return this._continuing_statement();if(this._check(Lt.keywords.static_assert))return this._static_assert_statement();if(this._check(Lt.tokens.brace_left))return this._compound_statement();let t=null;return t=this._check(Lt.keywords.return)?this._return_statement():this._check([Lt.keywords.var,Lt.keywords.let,Lt.keywords.const])?this._variable_statement():this._match(Lt.keywords.discard)?new tt:this._match(Lt.keywords.break)?new et:this._match(Lt.keywords.continue)?new st:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),null!=t&&this._consume(Lt.tokens.semicolon,"Expected ';' after statement."),t}_static_assert_statement(){if(!this._match(Lt.keywords.static_assert))return null;const t=this._optional_paren_expression();return new M(t)}_while_statement(){if(!this._match(Lt.keywords.while))return null;const t=this._optional_paren_expression();this._check(Lt.tokens.attr)&&this._attribute();const e=this._compound_statement();return new U(t,e)}_continuing_statement(){if(!this._match(Lt.keywords.continuing))return null;const t=this._compound_statement();return new F(t)}_for_statement(){if(!this._match(Lt.keywords.for))return null;this._consume(Lt.tokens.paren_left,"Expected '('.");const t=this._check(Lt.tokens.semicolon)?null:this._for_init();this._consume(Lt.tokens.semicolon,"Expected ';'.");const e=this._check(Lt.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(Lt.tokens.semicolon,"Expected ';'.");const s=this._check(Lt.tokens.paren_right)?null:this._for_increment();this._consume(Lt.tokens.paren_right,"Expected ')'."),this._check(Lt.tokens.attr)&&this._attribute();const n=this._compound_statement();return new B(t,e,s,n)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(Lt.keywords.var)){const t=this._variable_decl();if(null===t)throw this._error(this._peek(),"Variable declaration expected.");let e=null;return this._match(Lt.tokens.equal)&&(e=this._short_circuit_or_expression()),new z(t.name,t.type,t.storage,t.access,e)}if(this._match(Lt.keywords.let)){const t=this._consume(Lt.tokens.ident,"Expected name for let.").toString();let e=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();e=this._type_decl(),null!=e&&(e.attributes=t)}this._consume(Lt.tokens.equal,"Expected '=' for let.");const s=this._short_circuit_or_expression();return new D(t,e,null,null,s)}if(this._match(Lt.keywords.const)){const t=this._consume(Lt.tokens.ident,"Expected name for const.").toString();let e=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();e=this._type_decl(),null!=e&&(e.attributes=t)}this._consume(Lt.tokens.equal,"Expected '=' for const.");const s=this._short_circuit_or_expression();return new Z(t,e,null,null,s)}return null}_increment_decrement_statement(){const t=this._current,e=this._unary_expression();if(null==e)return null;if(!this._check(Lt.increment_operators))return this._current=t,null;const s=this._consume(Lt.increment_operators,"Expected increment operator");return new V(s.type===Lt.tokens.plus_plus?w.increment:w.decrement,e)}_assignment_statement(){let t=null;if(this._check(Lt.tokens.brace_right))return null;let e=this._match(Lt.tokens.underscore);if(e||(t=this._unary_expression()),!e&&null==t)return null;const s=this._consume(Lt.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return new q(x.parse(s.lexeme),t,n)}_func_call_statement(){if(!this._check(Lt.tokens.ident))return null;const t=this._current,e=this._consume(Lt.tokens.ident,"Expected function name."),s=this._argument_expression_list();return null===s?(this._current=t,null):new W(e.lexeme,s)}_loop_statement(){if(!this._match(Lt.keywords.loop))return null;this._check(Lt.tokens.attr)&&this._attribute(),this._consume(Lt.tokens.brace_left,"Expected '{' for loop.");const t=[];let e=this._statement();for(;null!==e;){if(Array.isArray(e))for(let s of e)t.push(s);else t.push(e);e=this._statement()}let s=null;return this._match(Lt.keywords.continuing)&&(s=this._compound_statement()),this._consume(Lt.tokens.brace_right,"Expected '}' for loop."),new G(t,s)}_switch_statement(){if(!this._match(Lt.keywords.switch))return null;const t=this._optional_paren_expression();this._check(Lt.tokens.attr)&&this._attribute(),this._consume(Lt.tokens.brace_left,"Expected '{' for switch.");const e=this._switch_body();if(null==e||0==e.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(Lt.tokens.brace_right,"Expected '}' for switch."),new H(t,e)}_switch_body(){const t=[];if(this._match(Lt.keywords.case)){const e=this._case_selectors();this._match(Lt.tokens.colon),this._check(Lt.tokens.attr)&&this._attribute(),this._consume(Lt.tokens.brace_left,"Exected '{' for switch case.");const s=this._case_body();this._consume(Lt.tokens.brace_right,"Exected '}' for switch case."),t.push(new At(e,s))}if(this._match(Lt.keywords.default)){this._match(Lt.tokens.colon),this._check(Lt.tokens.attr)&&this._attribute(),this._consume(Lt.tokens.brace_left,"Exected '{' for switch default.");const e=this._case_body();this._consume(Lt.tokens.brace_right,"Exected '}' for switch default."),t.push(new Tt(e))}if(this._check([Lt.keywords.default,Lt.keywords.case])){const e=this._switch_body();t.push(e[0])}return t}_case_selectors(){const t=[this._shift_expression()];for(;this._match(Lt.tokens.comma);)t.push(this._shift_expression());return t}_case_body(){if(this._match(Lt.keywords.fallthrough))return this._consume(Lt.tokens.semicolon,"Expected ';'"),[];let t=this._statement();if(null==t)return[];t instanceof Array||(t=[t]);const e=this._case_body();return 0==e.length?t:[...t,e[0]]}_if_statement(){if(!this._match(Lt.keywords.if))return null;const t=this._optional_paren_expression();this._check(Lt.tokens.attr)&&this._attribute();const e=this._compound_statement();let s=[];this._match_elseif()&&(this._check(Lt.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let n=null;return this._match(Lt.keywords.else)&&(this._check(Lt.tokens.attr)&&this._attribute(),n=this._compound_statement()),new Y(t,e,s,n)}_match_elseif(){return this._tokens[this._current].type===Lt.keywords.else&&this._tokens[this._current+1].type===Lt.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const e=this._optional_paren_expression(),s=this._compound_statement();return t.push(new St(e,s)),this._match_elseif()&&(this._check(Lt.tokens.attr)&&this._attribute(),this._elseif_statement(t)),t}_return_statement(){if(!this._match(Lt.keywords.return))return null;const t=this._short_circuit_or_expression();return new K(t)}_short_circuit_or_expression(){let t=this._short_circuit_and_expr();for(;this._match(Lt.tokens.or_or);)t=new xt(this._previous().toString(),t,this._short_circuit_and_expr());return t}_short_circuit_and_expr(){let t=this._inclusive_or_expression();for(;this._match(Lt.tokens.and_and);)t=new xt(this._previous().toString(),t,this._inclusive_or_expression());return t}_inclusive_or_expression(){let t=this._exclusive_or_expression();for(;this._match(Lt.tokens.or);)t=new xt(this._previous().toString(),t,this._exclusive_or_expression());return t}_exclusive_or_expression(){let t=this._and_expression();for(;this._match(Lt.tokens.xor);)t=new xt(this._previous().toString(),t,this._and_expression());return t}_and_expression(){let t=this._equality_expression();for(;this._match(Lt.tokens.and);)t=new xt(this._previous().toString(),t,this._equality_expression());return t}_equality_expression(){const t=this._relational_expression();return this._match([Lt.tokens.equal_equal,Lt.tokens.not_equal])?new xt(this._previous().toString(),t,this._relational_expression()):t}_relational_expression(){let t=this._shift_expression();for(;this._match([Lt.tokens.less_than,Lt.tokens.greater_than,Lt.tokens.less_than_equal,Lt.tokens.greater_than_equal]);)t=new xt(this._previous().toString(),t,this._shift_expression());return t}_shift_expression(){let t=this._additive_expression();for(;this._match([Lt.tokens.shift_left,Lt.tokens.shift_right]);)t=new xt(this._previous().toString(),t,this._additive_expression());return t}_additive_expression(){let t=this._multiplicative_expression();for(;this._match([Lt.tokens.plus,Lt.tokens.minus]);)t=new xt(this._previous().toString(),t,this._multiplicative_expression());return t}_multiplicative_expression(){let t=this._unary_expression();for(;this._match([Lt.tokens.star,Lt.tokens.forward_slash,Lt.tokens.modulo]);)t=new xt(this._previous().toString(),t,this._unary_expression());return t}_unary_expression(){return this._match([Lt.tokens.minus,Lt.tokens.bang,Lt.tokens.tilde,Lt.tokens.star,Lt.tokens.and])?new wt(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const t=this._primary_expression(),e=this._postfix_expression();return e&&(t.postfix=e),t}_postfix_expression(){if(this._match(Lt.tokens.bracket_left)){const t=this._short_circuit_or_expression();this._consume(Lt.tokens.bracket_right,"Expected ']'.");const e=new vt(t),s=this._postfix_expression();return s&&(e.postfix=s),e}if(this._match(Lt.tokens.period)){const t=this._consume(Lt.tokens.ident,"Expected member name."),e=this._postfix_expression(),s=new lt(t.lexeme);return e&&(s.postfix=e),s}return null}_getStruct(t){if(this._context.aliases.has(t)){return this._context.aliases.get(t).type}if(this._context.structs.has(t)){return this._context.structs.get(t)}return null}_primary_expression(){if(this._match(Lt.tokens.ident)){const t=this._previous().toString();if(this._check(Lt.tokens.paren_left)){const e=this._argument_expression_list(),s=this._getStruct(t);return null!=s?new ht(s,e):new dt(t,e)}if(this._context.constants.has(t)){const e=this._context.constants.get(t);return new pt(t,e.value)}return new ft(t)}if(this._match(Lt.const_literal))return new gt(parseFloat(this._previous().toString()));if(this._check(Lt.tokens.paren_left))return this._paren_expression();if(this._match(Lt.keywords.bitcast)){this._consume(Lt.tokens.less_than,"Expected '<'.");const t=this._type_decl();this._consume(Lt.tokens.greater_than,"Expected '>'.");const e=this._paren_expression();return new _t(t,e)}const t=this._type_decl(),e=this._argument_expression_list();return new mt(t,e)}_argument_expression_list(){if(!this._match(Lt.tokens.paren_left))return null;const t=[];do{if(this._check(Lt.tokens.paren_right))break;const e=this._short_circuit_or_expression();t.push(e)}while(this._match(Lt.tokens.comma));return this._consume(Lt.tokens.paren_right,"Expected ')' for agument list"),t}_optional_paren_expression(){this._match(Lt.tokens.paren_left);const t=this._short_circuit_or_expression();return this._match(Lt.tokens.paren_right),new yt([t])}_paren_expression(){this._consume(Lt.tokens.paren_left,"Expected '('.");const t=this._short_circuit_or_expression();return this._consume(Lt.tokens.paren_right,"Expected ')'."),new yt([t])}_struct_decl(){if(!this._match(Lt.keywords.struct))return null;const t=this._currentLine,e=this._consume(Lt.tokens.ident,"Expected name for struct.").toString();this._consume(Lt.tokens.brace_left,"Expected '{' for struct body.");const s=[];for(;!this._check(Lt.tokens.brace_right);){const t=this._attribute(),e=this._consume(Lt.tokens.ident,"Expected variable name.").toString();this._consume(Lt.tokens.colon,"Expected ':' for struct member type.");const n=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=n),this._check(Lt.tokens.brace_right)?this._match(Lt.tokens.comma):this._consume(Lt.tokens.comma,"Expected ',' for struct member."),s.push(new Ct(e,i,t))}this._consume(Lt.tokens.brace_right,"Expected '}' after struct body.");const n=this._currentLine,i=new it(e,s,t,n);return this._context.structs.set(e,i),i}_global_variable_decl(){const t=this._variable_decl();return t&&this._match(Lt.tokens.equal)&&(t.value=this._const_expression()),t}_override_variable_decl(){const t=this._override_decl();return t&&this._match(Lt.tokens.equal)&&(t.value=this._const_expression()),t}_global_const_decl(){if(!this._match(Lt.keywords.const))return null;const t=this._consume(Lt.tokens.ident,"Expected variable name");let e=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();e=this._type_decl(),null!=e&&(e.attributes=t)}let s=null;if(this._match(Lt.tokens.equal)){const t=this._short_circuit_or_expression();if(t instanceof ht)s=t;else if(t instanceof pt&&t.initializer instanceof ht)s=t.initializer;else try{const e=t.evaluate(this._context);s=new gt(e)}catch(k){s=t}}const n=new Z(t.toString(),e,"","",s);return this._context.constants.set(n.name,n),n}_global_let_decl(){if(!this._match(Lt.keywords.let))return null;const t=this._consume(Lt.tokens.ident,"Expected variable name");let e=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();e=this._type_decl(),null!=e&&(e.attributes=t)}let s=null;return this._match(Lt.tokens.equal)&&(s=this._const_expression()),new D(t.toString(),e,"","",s)}_const_expression(){if(this._match(Lt.const_literal))return new lt(this._previous().toString());const t=this._type_decl();this._consume(Lt.tokens.paren_left,"Expected '('.");let e=[];for(;!this._check(Lt.tokens.paren_right)&&(e.push(this._const_expression()),this._check(Lt.tokens.comma));)this._advance();return this._consume(Lt.tokens.paren_right,"Expected ')'."),new ht(t,e)}_variable_decl(){if(!this._match(Lt.keywords.var))return null;let t="",e="";this._match(Lt.tokens.less_than)&&(t=this._consume(Lt.storage_class,"Expected storage_class.").toString(),this._match(Lt.tokens.comma)&&(e=this._consume(Lt.access_mode,"Expected access_mode.").toString()),this._consume(Lt.tokens.greater_than,"Expected '>'."));const s=this._consume(Lt.tokens.ident,"Expected variable name");let n=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=t)}return new z(s.toString(),n,t,e,null)}_override_decl(){if(!this._match(Lt.keywords.override))return null;const t=this._consume(Lt.tokens.ident,"Expected variable name");let e=null;if(this._match(Lt.tokens.colon)){const t=this._attribute();e=this._type_decl(),null!=e&&(e.attributes=t)}return new j(t.toString(),e,null)}_diagnostic(){this._consume(Lt.tokens.paren_left,"Expected '('");const t=this._consume(Lt.tokens.ident,"Expected severity control name.");this._consume(Lt.tokens.comma,"Expected ','");const e=this._consume(Lt.tokens.ident,"Expected diagnostic rule name.");return this._consume(Lt.tokens.paren_right,"Expected ')'"),new Q(t.toString(),e.toString())}_enable_directive(){const t=this._consume(Lt.tokens.ident,"identity expected.");return new X(t.toString())}_requires_directive(){const t=[this._consume(Lt.tokens.ident,"identity expected.").toString()];for(;this._match(Lt.tokens.comma);){const e=this._consume(Lt.tokens.ident,"identity expected.");t.push(e.toString())}return new J(t)}_type_alias(){const t=this._consume(Lt.tokens.ident,"identity expected.");this._consume(Lt.tokens.equal,"Expected '=' for type alias.");let e=this._type_decl();if(null===e)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);const s=new $(t.toString(),e);return this._context.aliases.set(s.name,s),s}_type_decl(){if(this._check([Lt.tokens.ident,...Lt.texel_format,Lt.keywords.bool,Lt.keywords.f32,Lt.keywords.i32,Lt.keywords.u32])){const t=this._advance(),e=t.toString();return this._context.structs.has(e)?this._context.structs.get(e):this._context.aliases.has(e)?this._context.aliases.get(e).type:new nt(t.toString())}let t=this._texture_sampler_types();if(t)return t;if(this._check(Lt.template_types)){let t=this._advance().toString(),e=null,s=null;return this._match(Lt.tokens.less_than)&&(e=this._type_decl(),s=null,this._match(Lt.tokens.comma)&&(s=this._consume(Lt.access_mode,"Expected access_mode for pointer").toString()),this._consume(Lt.tokens.greater_than,"Expected '>' for type.")),new rt(t,e,s)}if(this._match(Lt.keywords.ptr)){let t=this._previous().toString();this._consume(Lt.tokens.less_than,"Expected '<' for pointer.");const e=this._consume(Lt.storage_class,"Expected storage_class for pointer");this._consume(Lt.tokens.comma,"Expected ',' for pointer.");const s=this._type_decl();let n=null;return this._match(Lt.tokens.comma)&&(n=this._consume(Lt.access_mode,"Expected access_mode for pointer").toString()),this._consume(Lt.tokens.greater_than,"Expected '>' for pointer."),new ot(t,e.toString(),s,n)}const e=this._attribute();if(this._match(Lt.keywords.array)){let t=null,n=-1;const i=this._previous();let r=null;if(this._match(Lt.tokens.less_than)){t=this._type_decl(),this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let e="";if(this._match(Lt.tokens.comma)){r=this._shift_expression();try{e=r.evaluate(this._context).toString(),r=null}catch(s){e="1"}}this._consume(Lt.tokens.greater_than,"Expected '>' for array."),n=e?parseInt(e):0}const o=new at(i.toString(),e,t,n);return r&&this._deferArrayCountEval.push({arrayType:o,countNode:r}),o}return null}_texture_sampler_types(){if(this._match(Lt.sampler_type))return new ct(this._previous().toString(),null,null);if(this._match(Lt.depth_texture_type))return new ct(this._previous().toString(),null,null);if(this._match(Lt.sampled_texture_type)||this._match(Lt.multisampled_texture_type)){const t=this._previous();this._consume(Lt.tokens.less_than,"Expected '<' for sampler type.");const e=this._type_decl();return this._consume(Lt.tokens.greater_than,"Expected '>' for sampler type."),new ct(t.toString(),e,null)}if(this._match(Lt.storage_texture_type)){const t=this._previous();this._consume(Lt.tokens.less_than,"Expected '<' for sampler type.");const e=this._consume(Lt.texel_format,"Invalid texel format.").toString();this._consume(Lt.tokens.comma,"Expected ',' after texel format.");const s=this._consume(Lt.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(Lt.tokens.greater_than,"Expected '>' for sampler type."),new ct(t.toString(),e,s)}return null}_attribute(){let t=[];for(;this._match(Lt.tokens.attr);){const e=this._consume(Lt.attribute_name,"Expected attribute name"),s=new Et(e.toString(),null);if(this._match(Lt.tokens.paren_left)){if(s.value=this._consume(Lt.literal_or_ident,"Expected attribute value").toString(),this._check(Lt.tokens.comma)){this._advance();do{const t=this._consume(Lt.literal_or_ident,"Expected attribute value").toString();s.value instanceof Array||(s.value=[s.value]),s.value.push(t)}while(this._match(Lt.tokens.comma))}this._consume(Lt.tokens.paren_right,"Expected ')'")}t.push(s)}return 0==t.length?null:t}}class Mt{constructor(t,e){this.name=t,this.attributes=e,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Ut{constructor(t,e,s){this.name=t,this.type=e,this.attributes=s,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ft extends Mt{constructor(t,e){super(t,e),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Bt extends Mt{constructor(t,e){super(t,e),this.count=0,this.stride=0}get isArray(){return!0}}class zt extends Mt{constructor(t,e,s,n){super(t,s),this.format=e,this.access=n}get isTemplate(){return!0}}!function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"}(T||(T={}));class jt{constructor(t,e,s,n,i,r,o){this.name=t,this.type=e,this.group=s,this.binding=n,this.attributes=i,this.resourceType=r,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Dt{constructor(t,e){this.name=t,this.type=e}}class Zt{constructor(t,e){this.align=t,this.size=e}}class Vt{constructor(t,e,s,n){this.name=t,this.type=e,this.locationType=s,this.location=n,this.interpolation=null}}class qt{constructor(t,e,s,n){this.name=t,this.type=e,this.locationType=s,this.location=n}}class Wt{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=t,this.stage=e}}class Gt{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class Ht{constructor(t,e,s,n){this.name=t,this.type=e,this.attributes=s,this.id=n}}class Yt{constructor(t){this.resources=null,this.inUse=!1,this.info=null,this.node=t}}class Kt{constructor(t){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new Gt,this.functions=[],this._types=new Map,this._functions=new Map,t&&this.update(t)}_isStorageTexture(t){return"texture_storage_1d"==t.name||"texture_storage_2d"==t.name||"texture_storage_2d_array"==t.name||"texture_storage_3d"==t.name}update(t){const e=(new Nt).parse(t);for(const s of e)s instanceof N&&this._functions.set(s.name,new Yt(s));for(const s of e)if(s instanceof it){const t=this._getTypeInfo(s,null);t instanceof Ft&&this.structs.push(t)}for(const s of e)if(s instanceof $)this.aliases.push(this._getAliasInfo(s));else if(s instanceof j){const t=s,e=this._getAttributeNum(t.attributes,"id",0),n=null!=t.type?this._getTypeInfo(t.type,t.attributes):null;this.overrides.push(new Ht(t.name,n,t.attributes,e))}else if(this._isUniformVar(s)){const t=s,e=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),r=new jt(t.name,i,e,n,t.attributes,T.Uniform,t.access);this.uniforms.push(r)}else if(this._isStorageVar(s)){const t=s,e=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),r=this._isStorageTexture(i),o=new jt(t.name,i,e,n,t.attributes,r?T.StorageTexture:T.Storage,t.access);this.storage.push(o)}else if(this._isTextureVar(s)){const t=s,e=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),r=this._isStorageTexture(i),o=new jt(t.name,i,e,n,t.attributes,r?T.StorageTexture:T.Texture,t.access);r?this.storage.push(o):this.textures.push(o)}else if(this._isSamplerVar(s)){const t=s,e=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),r=new jt(t.name,i,e,n,t.attributes,T.Sampler,t.access);this.samplers.push(r)}else if(s instanceof N){const t=this._getAttribute(s,"vertex"),e=this._getAttribute(s,"fragment"),n=this._getAttribute(s,"compute"),i=t||e||n,r=new Wt(s.name,null===i||void 0===i?void 0:i.name);r.startLine=s.startLine,r.endLine=s.endLine,this.functions.push(r),this._functions.get(s.name).info=r,i&&(this._functions.get(s.name).inUse=!0,r.inUse=!0,r.resources=this._findResources(s,!!i),r.inputs=this._getInputs(s.args),r.outputs=this._getOutputs(s.returnType),this.entry[i.name].push(r))}else;for(const s of this._functions.values())s.info&&(s.info.inUse=s.inUse,this._addCalls(s.node,s.info.calls));for(const s of this.uniforms)this._markStructsInUse(s.type);for(const s of this.storage)this._markStructsInUse(s.type)}_markStructsInUse(t){if(t.isStruct){t.inUse=!0;for(const e of t.members)this._markStructsInUse(e.type)}else if(t.isArray)this._markStructsInUse(t.format);else if(t.isTemplate)this._markStructsInUse(t.format);else{const e=this._getAlias(t.name);e&&this._markStructsInUse(e)}}_addCalls(t,e){var s;for(const n of t.calls){const t=null===(s=this._functions.get(n.name))||void 0===s?void 0:s.info;t&&e.add(t)}}findResource(t,e){for(const s of this.uniforms)if(s.group==t&&s.binding==e)return s;for(const s of this.storage)if(s.group==t&&s.binding==e)return s;for(const s of this.textures)if(s.group==t&&s.binding==e)return s;for(const s of this.samplers)if(s.group==t&&s.binding==e)return s;return null}_findResource(t){for(const e of this.uniforms)if(e.name==t)return e;for(const e of this.storage)if(e.name==t)return e;for(const e of this.textures)if(e.name==t)return e;for(const e of this.samplers)if(e.name==t)return e;return null}_markStructsFromAST(t){const e=this._getTypeInfo(t,null);this._markStructsInUse(e)}_findResources(t,e){const s=[],n=this,i=[];return t.search((r=>{if(r instanceof L)i.push({});else if(r instanceof O)i.pop();else if(r instanceof z){const t=r;e&&null!==t.type&&this._markStructsFromAST(t.type),i.length>0&&(i[i.length-1][t.name]=t)}else if(r instanceof ht){const t=r;e&&null!==t.type&&this._markStructsFromAST(t.type)}else if(r instanceof D){const t=r;e&&null!==t.type&&this._markStructsFromAST(t.type),i.length>0&&(i[i.length-1][t.name]=t)}else if(r instanceof ft){const t=r;if(i.length>0){if(i[i.length-1][t.name])return}const e=n._findResource(t.name);e&&s.push(e)}else if(r instanceof dt){const i=r,o=n._functions.get(i.name);o&&(e&&(o.inUse=!0),t.calls.add(o.node),null===o.resources&&(o.resources=n._findResources(o.node,e)),s.push(...o.resources))}else if(r instanceof W){const i=r,o=n._functions.get(i.name);o&&(e&&(o.inUse=!0),t.calls.add(o.node),null===o.resources&&(o.resources=n._findResources(o.node,e)),s.push(...o.resources))}})),[...new Map(s.map((t=>[t.name,t]))).values()]}getBindGroups(){const t=[];function e(e,s){e>=t.length&&(t.length=e+1),void 0===t[e]&&(t[e]=[]),s>=t[e].length&&(t[e].length=s+1)}for(const s of this.uniforms){e(s.group,s.binding);t[s.group][s.binding]=s}for(const s of this.storage){e(s.group,s.binding);t[s.group][s.binding]=s}for(const s of this.textures){e(s.group,s.binding);t[s.group][s.binding]=s}for(const s of this.samplers){e(s.group,s.binding);t[s.group][s.binding]=s}return t}_getOutputs(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;if(void 0===e&&(e=[]),t instanceof it)this._getStructOutputs(t,e);else{const s=this._getOutputInfo(t);null!==s&&e.push(s)}return e}_getStructOutputs(t,e){for(const s of t.members)if(s.type instanceof it)this._getStructOutputs(s.type,e);else{const t=this._getAttribute(s,"location")||this._getAttribute(s,"builtin");if(null!==t){const n=this._getTypeInfo(s.type,s.type.attributes),i=this._parseInt(t.value),r=new qt(s.name,n,t.name,i);e.push(r)}}}_getOutputInfo(t){const e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(null!==e){const s=this._getTypeInfo(t,t.attributes),n=this._parseInt(e.value);return new qt("",s,e.name,n)}return null}_getInputs(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;void 0===e&&(e=[]);for(const s of t)if(s.type instanceof it)this._getStructInputs(s.type,e);else{const t=this._getInputInfo(s);null!==t&&e.push(t)}return e}_getStructInputs(t,e){for(const s of t.members)if(s.type instanceof it)this._getStructInputs(s.type,e);else{const t=this._getInputInfo(s);null!==t&&e.push(t)}}_getInputInfo(t){const e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(null!==e){const s=this._getAttribute(t,"interpolation"),n=this._getTypeInfo(t.type,t.attributes),i=this._parseInt(e.value),r=new Vt(t.name,n,e.name,i);return null!==s&&(r.interpolation=this._parseString(s.value)),r}return null}_parseString(t){return t instanceof Array&&(t=t[0]),t}_parseInt(t){t instanceof Array&&(t=t[0]);const e=parseInt(t);return isNaN(e)?t:e}_getAlias(t){for(const e of this.aliases)if(e.name==t)return e.type;return null}_getAliasInfo(t){return new Dt(t.name,this._getTypeInfo(t.type,null))}_getTypeInfo(t,e){if(this._types.has(t))return this._types.get(t);if(t instanceof at){const s=t,n=this._getTypeInfo(s.format,s.attributes),i=new Bt(s.name,e);return i.format=n,i.count=s.count,this._types.set(t,i),this._updateTypeInfo(i),i}if(t instanceof it){const s=t,n=new Ft(s.name,e);n.startLine=s.startLine,n.endLine=s.endLine;for(const t of s.members){const e=this._getTypeInfo(t.type,t.attributes);n.members.push(new Ut(t.name,e,t.attributes))}return this._types.set(t,n),this._updateTypeInfo(n),n}if(t instanceof ct){const s=t,n=s.format instanceof nt,i=s.format?n?this._getTypeInfo(s.format,null):new Mt(s.format,null):null,r=new zt(s.name,i,e,s.access);return this._types.set(t,r),this._updateTypeInfo(r),r}if(t instanceof rt){const s=t,n=s.format?this._getTypeInfo(s.format,null):null,i=new zt(s.name,n,e,s.access);return this._types.set(t,i),this._updateTypeInfo(i),i}const s=new Mt(t.name,e);return this._types.set(t,s),this._updateTypeInfo(s),s}_updateTypeInfo(t){var e,s;const n=this._getTypeSize(t);if(t.size=null!==(e=null===n||void 0===n?void 0:n.size)&&void 0!==e?e:0,t instanceof Bt){const e=this._getTypeSize(t.format);t.stride=null!==(s=null===e||void 0===e?void 0:e.size)&&void 0!==s?s:0,this._updateTypeInfo(t.format)}t instanceof Ft&&this._updateStructInfo(t)}_updateStructInfo(t){var e;let s=0,n=0,i=0,r=0;for(let o=0,a=t.members.length;o<a;++o){const a=t.members[o],c=this._getTypeSize(a);if(!c)continue;null!==(e=this._getAlias(a.type.name))&&void 0!==e||a.type;const u=c.align,l=c.size;s=this._roundUp(u,s+n),n=l,i=s,r=Math.max(r,u),a.offset=s,a.size=l,this._updateTypeInfo(a.type)}t.size=this._roundUp(r,i+n),t.align=r}_getTypeSize(t){var e,s;if(null===t||void 0===t)return null;const n=this._getAttributeNum(t.attributes,"size",0),i=this._getAttributeNum(t.attributes,"align",0);if(t instanceof Ut&&(t=t.type),t instanceof Mt){const e=this._getAlias(t.name);null!==e&&(t=e)}{const s=Kt._typeInfo[t.name];if(void 0!==s){const r="f16"===(null===(e=t.format)||void 0===e?void 0:e.name)?2:1;return new Zt(Math.max(i,s.align/r),Math.max(n,s.size/r))}}{const e=Kt._typeInfo[t.name.substring(0,t.name.length-1)];if(e){const s="h"===t.name[t.name.length-1]?2:1;return new Zt(Math.max(i,e.align/s),Math.max(n,e.size/s))}}if(t instanceof Bt){let e=t,r=8,o=8;const a=this._getTypeSize(e.format);null!==a&&(o=a.size,r=a.align);return o=e.count*this._getAttributeNum(null!==(s=null===t||void 0===t?void 0:t.attributes)&&void 0!==s?s:null,"stride",this._roundUp(r,o)),n&&(o=n),new Zt(Math.max(i,r),Math.max(n,o))}if(t instanceof Ft){let e=0,s=0,r=0,o=0,a=0;for(const n of t.members){const t=this._getTypeSize(n.type);null!==t&&(e=Math.max(t.align,e),r=this._roundUp(t.align,r+o),o=t.size,a=r)}return s=this._roundUp(e,a+o),new Zt(Math.max(i,e),Math.max(n,s))}return null}_isUniformVar(t){return t instanceof z&&"uniform"==t.storage}_isStorageVar(t){return t instanceof z&&"storage"==t.storage}_isTextureVar(t){return t instanceof z&&null!==t.type&&-1!=Kt._textureTypes.indexOf(t.type.name)}_isSamplerVar(t){return t instanceof z&&null!==t.type&&-1!=Kt._samplerTypes.indexOf(t.type.name)}_getAttribute(t,e){const s=t;if(!s||!s.attributes)return null;const n=s.attributes;for(let i of n)if(i.name==e)return i;return null}_getAttributeNum(t,e,s){if(null===t)return s;for(let n of t)if(n.name==e){let t=null!==n&&null!==n.value?n.value:s;return t instanceof Array&&(t=t[0]),"number"===typeof t?t:"string"===typeof t?parseInt(t):s}return s}_roundUp(t,e){return Math.ceil(e/t)*t}}function Xt(t){const e={attributes:[],bindings:[]};let s;try{s=function(t){try{return new Kt(t)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw"object"===typeof e&&null!==e&&void 0!==e&&e.message&&(t+=": ".concat(e.message," ")),"object"===typeof e&&null!==e&&void 0!==e&&e.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}(t)}catch(o){return g.c.error(o.message)(),e}for(const a of s.uniforms){const t=[];for(const e of(null===(n=a.type)||void 0===n?void 0:n.members)||[]){var n;t.push({name:e.name,type:Jt(e.type)})}e.bindings.push({type:"uniform",name:a.name,location:a.binding,group:a.group,members:t})}const i=s.entry.vertex[0],r=(null===i||void 0===i?void 0:i.inputs.length)||0;for(let a=0;a<r;a++){const t=i.inputs[a];if("location"===t.locationType){const s=Jt(t.type);e.attributes.push({name:t.name,location:Number(t.location),type:s})}}return e}function Jt(t){return t.format?"".concat(t.name,"<").concat(t.format.name,">"):t.name}Kt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Kt._textureTypes=Lt.any_texture_type.map((t=>t.name)),Kt._samplerTypes=Lt.sampler_type.map((t=>t.name));var Qt=s(15572);class $t{constructor(t){(0,n.Z)(this,"id",void 0),(0,n.Z)(this,"userData",{}),(0,n.Z)(this,"topology",void 0),(0,n.Z)(this,"bufferLayout",[]),(0,n.Z)(this,"vertexCount",void 0),(0,n.Z)(this,"indices",void 0),(0,n.Z)(this,"attributes",void 0),this.id=t.id||(0,v.h)("geometry"),this.topology=t.topology,this.indices=t.indices||null,this.attributes=t.attributes,this.vertexCount=t.vertexCount,this.bufferLayout=t.bufferLayout||[],this.indices&&(0,l.h)(this.indices.usage===r.l.INDEX)}destroy(){var t;null===(t=this.indices)||void 0===t||t.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices}_calculateVertexCount(t){return t.byteLength/12}}function te(t,e){if(e instanceof $t)return e;const s=function(t,e){if(!e.indices)return;const s=e.indices.value;return t.createBuffer({usage:r.l.INDEX,data:s})}(t,e),{attributes:n,bufferLayout:i}=function(t,e){const s=[],n={};for(const[r,o]of Object.entries(e.attributes)){let e=r;switch(r){case"POSITION":e="positions";break;case"NORMAL":e="normals";break;case"TEXCOORD_0":e="texCoords";break;case"COLOR_0":e="colors"}n[e]=t.createBuffer({data:o.value,id:"".concat(r,"-buffer")});const{value:i,size:a,normalized:c}=o;s.push({name:e,format:(0,C.sk)(i,a,c)})}const i=e._calculateVertexCount(e.attributes,e.indices);return{attributes:n,bufferLayout:s,vertexCount:i}}(t,e);return new $t({topology:e.topology||"triangle-list",bufferLayout:i,vertexCount:e.vertexCount,indices:s,attributes:n})}var ee=s(54933);class se{constructor(t){(0,n.Z)(this,"modules",void 0),(0,n.Z)(this,"moduleUniforms",void 0),(0,n.Z)(this,"moduleBindings",void 0),(0,n.Z)(this,"moduleUniformsChanged",void 0);const e=(0,ee.WQ)(Object.values(t).filter((t=>t.dependencies)));for(const s of e)t[s.name]=s;g.c.log(1,"Creating ShaderInputs with modules",Object.keys(t))(),this.modules=t,this.moduleUniforms={},this.moduleBindings={};for(const[s,n]of Object.entries(t)){const t=s;this.moduleUniforms[t]=n.defaultUniforms||{},this.moduleBindings[t]={}}}destroy(){}setProps(t){for(const s of Object.keys(t)){var e;const n=s,i=t[n],r=this.modules[n];if(!r){g.c.warn("Module ".concat(s," not found"))();continue}const o=this.moduleUniforms[n],a=this.moduleBindings[n],c=(null===(e=r.getUniforms)||void 0===e?void 0:e.call(r,i,o))||i,{uniforms:u,bindings:l}=(0,P.y)(c);this.moduleUniforms[n]={...o,...u},this.moduleBindings[n]={...a,...l}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindings(){const t={};for(const e of Object.values(this.moduleBindings))Object.assign(t,e);return t}getDebugTable(){const t={};for(const[s,n]of Object.entries(this.moduleUniforms))for(const[i,r]of Object.entries(n)){var e;t["".concat(s,".").concat(i)]={type:null===(e=this.modules[s].uniformTypes)||void 0===e?void 0:e[i],value:String(r)}}return t}}var ne=s(17302);let ie;ie=Symbol.toStringTag;class re extends ne._{get[ie](){return"ComputePipeline"}constructor(t,e){super(t,e,re.defaultProps),(0,n.Z)(this,"hash","")}}(0,n.Z)(re,"defaultProps",{...ne._.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});class oe{static getDefaultPipelineFactory(t){return t._lumaData.defaultPipelineFactory=t._lumaData.defaultPipelineFactory||new oe(t),t._lumaData.defaultPipelineFactory}constructor(t){(0,n.Z)(this,"device",void 0),(0,n.Z)(this,"_hashCounter",0),(0,n.Z)(this,"_hashes",{}),(0,n.Z)(this,"_renderPipelineCache",{}),(0,n.Z)(this,"_computePipelineCache",{}),this.device=t}createRenderPipeline(t){const e={...y.h.defaultProps,...t},s=this._hashRenderPipeline(e);if(!this._renderPipelineCache[s]){const t=this.device.createRenderPipeline({...e,id:e.id?"".concat(e.id,"-cached"):void 0});t.hash=s,this._renderPipelineCache[s]={pipeline:t,useCount:0}}return this._renderPipelineCache[s].useCount++,this._renderPipelineCache[s].pipeline}createComputePipeline(t){const e={...re.defaultProps,...t},s=this._hashComputePipeline(e);if(!this._computePipelineCache[s]){const t=this.device.createComputePipeline({...e,id:e.id?"".concat(e.id,"-cached"):void 0});t.hash=s,this._computePipelineCache[s]={pipeline:t,useCount:0}}return this._computePipelineCache[s].useCount++,this._computePipelineCache[s].pipeline}release(t){const e=t.hash,s=t instanceof re?this._computePipelineCache:this._renderPipelineCache;s[e].useCount--,0===s[e].useCount&&(s[e].pipeline.destroy(),delete s[e])}_hashComputePipeline(t){const e=this._getHash(t.shader.source);return"".concat(e)}_hashRenderPipeline(t){const e=this._getHash(t.vs.source),s=t.fs?this._getHash(t.fs.source):0,n=this._getHash(JSON.stringify(t.bufferLayout));if("webgl"===this.device.type)return"".concat(e,"/").concat(s,"V").concat("-","BL").concat(n);{const i=this._getHash(JSON.stringify(t.parameters));return"".concat(e,"/").concat(s,"V").concat("-","T").concat(t.topology,"P").concat(i,"BL").concat(n)}}_getHash(t){return void 0===this._hashes[t]&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}}(0,n.Z)(oe,"defaultProps",{...y.h.defaultProps});var ae=s(33750);class ce{static getDefaultShaderFactory(t){var e;return(e=t._lumaData).defaultShaderFactory||(e.defaultShaderFactory=new ce(t)),t._lumaData.defaultShaderFactory}constructor(t){(0,n.Z)(this,"device",void 0),(0,n.Z)(this,"_cache",{}),this.device=t}createShader(t){const e=this._hashShader(t);let s=this._cache[e];if(!s){const n=this.device.createShader({...t,id:t.id?"".concat(t.id,"-cached"):void 0});this._cache[e]=s={shader:n,useCount:0}}return s.useCount++,s.shader}release(t){const e=this._hashShader(t),s=this._cache[e];s&&(s.useCount--,0===s.useCount&&(delete this._cache[e],s.shader.destroy()))}_hashShader(t){return"".concat(t.stage,":").concat(t.source)}}(0,n.Z)(ce,"defaultProps",{...ae.e.defaultProps});let ue=null,le=null;class he{constructor(t,e){var s,i,r;(0,n.Z)(this,"device",void 0),(0,n.Z)(this,"id",void 0),(0,n.Z)(this,"source",void 0),(0,n.Z)(this,"vs",void 0),(0,n.Z)(this,"fs",void 0),(0,n.Z)(this,"pipelineFactory",void 0),(0,n.Z)(this,"shaderFactory",void 0),(0,n.Z)(this,"userData",{}),(0,n.Z)(this,"parameters",void 0),(0,n.Z)(this,"topology",void 0),(0,n.Z)(this,"bufferLayout",void 0),(0,n.Z)(this,"isInstanced",void 0),(0,n.Z)(this,"instanceCount",0),(0,n.Z)(this,"vertexCount",void 0),(0,n.Z)(this,"indexBuffer",null),(0,n.Z)(this,"bufferAttributes",{}),(0,n.Z)(this,"constantAttributes",{}),(0,n.Z)(this,"bindings",{}),(0,n.Z)(this,"uniforms",{}),(0,n.Z)(this,"vertexArray",void 0),(0,n.Z)(this,"transformFeedback",null),(0,n.Z)(this,"pipeline",void 0),(0,n.Z)(this,"shaderInputs",void 0),(0,n.Z)(this,"_uniformStore",void 0),(0,n.Z)(this,"_attributeInfos",{}),(0,n.Z)(this,"_gpuGeometry",null),(0,n.Z)(this,"_getModuleUniforms",void 0),(0,n.Z)(this,"props",void 0),(0,n.Z)(this,"_pipelineNeedsUpdate","newly created"),(0,n.Z)(this,"_needsRedraw","initializing"),(0,n.Z)(this,"_destroyed",!1),(0,n.Z)(this,"_lastDrawTimestamp",-1),(0,n.Z)(this,"_lastLogTime",0),(0,n.Z)(this,"_logOpen",!1),(0,n.Z)(this,"_drawCount",0),this.props={...he.defaultProps,...e},e=this.props,this.id=e.id||(0,v.h)("model"),this.device=t,Object.assign(this.userData,e.userData);const o=Object.fromEntries((null===(s=this.props.modules)||void 0===s?void 0:s.map((t=>[t.name,t])))||[]);this.setShaderInputs(e.shaderInputs||new se(o));const a=function(t){return{type:t.type,shaderLanguage:t.info.shadingLanguage,shaderLanguageVersion:t.info.shadingLanguageVersion,gpu:t.info.gpu,features:t.features}}(t),c=((null===(i=this.props.modules)||void 0===i?void 0:i.length)>0?this.props.modules:null===(r=this.shaderInputs)||void 0===r?void 0:r.getModules())||[];if("webgpu"===this.device.type&&this.props.source){var u;(u=this.props).shaderLayout||(u.shaderLayout=Xt(this.props.source));const{source:t,getUniforms:e}=this.props.shaderAssembler.assembleShader({platformInfo:a,...this.props,modules:c});this.source=t,this._getModuleUniforms=e}else{const{vs:t,fs:e,getUniforms:s}=this.props.shaderAssembler.assembleShaderPair({platformInfo:a,...this.props,modules:c});this.vs=t,this.fs=e,this._getModuleUniforms=s}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,e.geometry&&this.setGeometry(e.geometry),this.pipelineFactory=e.pipelineFactory||oe.getDefaultPipelineFactory(this.device),this.shaderFactory=e.shaderFactory||ce.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=t.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in e&&(this.isInstanced=e.isInstanced),e.instanceCount&&this.setInstanceCount(e.instanceCount),e.vertexCount&&this.setVertexCount(e.vertexCount),e.indexBuffer&&this.setIndexBuffer(e.indexBuffer),e.attributes&&this.setAttributes(e.attributes),e.constantAttributes&&this.setConstantAttributes(e.constantAttributes),e.bindings&&this.setBindings(e.bindings),e.uniforms&&this.setUniforms(e.uniforms),e.moduleSettings&&this.updateModuleSettings(e.moduleSettings),e.transformFeedback&&(this.transformFeedback=e.transformFeedback),Object.seal(this)}destroy(){var t;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),null===(t=this._gpuGeometry)||void 0===t||t.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const t=this._needsRedraw;return this._needsRedraw=!1,t}setNeedsRedraw(t){this._needsRedraw||(this._needsRedraw=t)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(t){let e;this.predraw();try{this._logDrawCallStart(),this.pipeline=this._updatePipeline(),this.pipeline.setBindings(this.bindings,{disableWarnings:this.props.disableWarnings}),(0,v.n)(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:s}=this.vertexArray,n=s?s.byteLength/("uint32"===s.indexType?4:2):void 0;e=this.pipeline.draw({renderPass:t,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:n,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{this._logDrawCallEnd()}return this._logFramebuffer(t),e?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",e}setGeometry(t){var e;null===(e=this._gpuGeometry)||void 0===e||e.destroy();const s=t&&te(this.device,t);s&&(this.setTopology(s.topology||"triangle-list"),this.bufferLayout=de(s.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(s)),this._gpuGeometry=s}setTopology(t){t!==this.topology&&(this.topology=t,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(t){this.bufferLayout=this._gpuGeometry?de(t,this._gpuGeometry.bufferLayout):t,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(t){b(t,this.parameters,2)||(this.parameters=t,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(t){this.instanceCount=t,void 0===this.isInstanced&&t>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(t){this.vertexCount=t,this.setNeedsRedraw("vertexCount")}setShaderInputs(t){this.shaderInputs=t,this._uniformStore=new m(this.shaderInputs.modules);for(const e of Object.keys(this.shaderInputs.modules)){const t=this._uniformStore.getManagedUniformBuffer(this.device,e);this.bindings["".concat(e,"Uniforms")]=t}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindings()),this.setNeedsRedraw("shaderInputs")}setBindings(t){Object.assign(this.bindings,t),this.setNeedsRedraw("bindings")}setTransformFeedback(t){this.transformFeedback=t,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(t){this.vertexArray.setIndexBuffer(t),this.setNeedsRedraw("indexBuffer")}setAttributes(t,e){t.indices&&g.c.warn("Model:".concat(this.id," setAttributes() - indexBuffer should be set using setIndexBuffer()"))();for(const[n,i]of Object.entries(t)){var s;const t=this.bufferLayout.find((t=>fe(t).includes(n)));if(!t){g.c.warn("Model(".concat(this.id,'): Missing layout for buffer "').concat(n,'".'))();continue}const r=fe(t);let o=!1;for(const e of r){const t=this._attributeInfos[e];t&&(this.vertexArray.setBuffer(t.location,i),o=!0)}o||(null!==(s=null===e||void 0===e?void 0:e.disableWarnings)&&void 0!==s?s:this.props.disableWarnings)||g.c.warn("Model(".concat(this.id,'): Ignoring buffer "').concat(i.id,'" for unknown attribute "').concat(n,'"'))()}this.setNeedsRedraw("attributes")}setConstantAttributes(t,e){for(const[n,i]of Object.entries(t)){var s;const t=this._attributeInfos[n];t?this.vertexArray.setConstantWebGL(t.location,i):(null!==(s=null===e||void 0===e?void 0:e.disableWarnings)&&void 0!==s?s:this.props.disableWarnings)||g.c.warn('Model "'.concat(this.id,': Ignoring constant supplied for unknown attribute "').concat(n,'"'))()}this.setNeedsRedraw("constants")}setUniforms(t){(0,v.n)(t)||(this.pipeline.setUniformsWebGL(t),Object.assign(this.uniforms,t)),this.setNeedsRedraw("uniforms")}updateModuleSettings(t){const{bindings:e,uniforms:s}=(0,P.y)(this._getModuleUniforms(t));Object.assign(this.bindings,e),Object.assign(this.uniforms,s),this.setNeedsRedraw("moduleSettings")}_getBindingsUpdateTimestamp(){let t=0;for(const e of Object.values(this.bindings))e instanceof i.s?t=Math.max(t,e.texture.updateTimestamp):e instanceof r.l||e instanceof o.x?t=Math.max(t,e.updateTimestamp):e instanceof a.Z||(t=Math.max(t,e.buffer.updateTimestamp));return t}_setGeometryAttributes(t){const e={...t.attributes};for(const[s]of Object.entries(e))this.pipeline.shaderLayout.attributes.find((t=>t.name===s))||"positions"===s||delete e[s];this.vertexCount=t.vertexCount,this.setIndexBuffer(t.indices||null),this.setAttributes(t.attributes,{disableWarnings:!0}),this.setAttributes(e,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(t){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=t),this.setNeedsRedraw(t)}_updatePipeline(){if(this._pipelineNeedsUpdate){let t=null,e=null;this.pipeline&&(g.c.log(1,"Model ".concat(this.id,': Recreating pipeline because "').concat(this._pipelineNeedsUpdate,'".'))(),t=this.pipeline.vs,e=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const s=this.shaderFactory.createShader({id:"".concat(this.id,"-vertex"),stage:"vertex",source:this.source||this.vs,debug:this.props.debugShaders});let n=null;this.source?n=s:this.fs&&(n=this.shaderFactory.createShader({id:"".concat(this.id,"-fragment"),stage:"fragment",source:this.source||this.fs,debug:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,vs:s,fs:n}),this._attributeInfos=(0,S.G5)(this.pipeline.shaderLayout,this.bufferLayout),t&&this.shaderFactory.release(t),e&&this.shaderFactory.release(e)}return this.pipeline}_logDrawCallStart(){const t=g.c.level>3?0:1e4;g.c.level<2||Date.now()-this._lastLogTime<t||(this._lastLogTime=Date.now(),this._logOpen=!0,g.c.group(2,">>> DRAWING MODEL ".concat(this.id),{collapsed:g.c.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const t=function(t,e){var s;const n={},i="Values";if(0===t.attributes.length&&(null===(s=t.varyings)||void 0===s||!s.length))return{"No attributes or varyings":{[i]:"N/A"}};for(const r of t.attributes)if(r){const t="".concat(r.location," ").concat(r.name,": ").concat(r.type);n["in ".concat(t)]={[i]:r.stepMode||"vertex"}}for(const r of t.varyings||[]){const t="".concat(r.location," ").concat(r.name);n["out ".concat(t)]={[i]:JSON.stringify(r.accessor)}}return n}(this.pipeline.shaderLayout,this.id);g.c.table(2,t)();const e=this.shaderInputs.getDebugTable();for(const[n,i]of Object.entries(this.uniforms))e[n]={value:i};g.c.table(2,e)();const s=this._getAttributeDebugTable();g.c.table(2,this._attributeInfos)(),g.c.table(2,s)(),g.c.groupEnd(2)(),this._logOpen=!1}}_logFramebuffer(t){const e=g.c.get("framebuffer");if(this._drawCount++,!e||this._drawCount++>3&&this._drawCount%60)return;const s=t.props.framebuffer;s&&function(t,e){let{id:s,minimap:n,opaque:i,top:r="0",left:o="0",rgbaScale:a=1}=e;ue||(ue=document.createElement("canvas"),ue.id=s,ue.title=s,ue.style.zIndex="100",ue.style.position="absolute",ue.style.top=r,ue.style.left=o,ue.style.border="blue 1px solid",ue.style.transform="scaleY(-1)",document.body.appendChild(ue),le=ue.getContext("2d")),ue.width===t.width&&ue.height===t.height||(ue.width=t.width/2,ue.height=t.height/2,ue.style.width="400px",ue.style.height="400px");const c=t.device.readPixelsToArrayWebGL(t),u=le.createImageData(t.width,t.height);for(let l=0;l<c.length;l+=4)u.data[0+l+0]=c[l+0]*a,u.data[0+l+1]=c[l+1]*a,u.data[0+l+2]=c[l+2]*a,u.data[0+l+3]=i?255:c[l+3]*a;le.putImageData(u,0,0)}(s,{id:s.id,minimap:!0})}_getAttributeDebugTable(){const t={};for(const[e,s]of Object.entries(this._attributeInfos))t[s.location]={name:e,type:s.shaderType,values:this._getBufferOrConstantValues(this.vertexArray.attributes[s.location],s.bufferDataType)};if(this.vertexArray.indexBuffer){const{indexBuffer:e}=this.vertexArray,s="uint32"===e.indexType?new Uint32Array(e.debugData):new Uint16Array(e.debugData);t.indices={name:"indices",type:e.indexType,values:s.toString()}}return t}_getBufferOrConstantValues(t,e){const s=(0,C.Xs)(e);return(t instanceof r.l?new s(t.debugData):t).toString()}}function de(t,e){const s=[...t];for(const n of e){const t=s.findIndex((t=>t.name===n.name));t<0?s.push(n):s[t]=n}return s}function fe(t){var e;return t.attributes?null===(e=t.attributes)||void 0===e?void 0:e.map((t=>t.attribute)):[t.name]}(0,n.Z)(he,"defaultProps",{...y.h.defaultProps,source:null,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Qt.q.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0})}}]);
//# sourceMappingURL=76379.b5123fa8.chunk.js.map